<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor Multimedia Local con Calendario</title>
    <!-- 
      Se utiliza la fuente "Inter" para un aspecto limpio y profesional.
      Cargada desde Google Fonts.
    -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 
      NUEVO: Biblioteca para leer metadatos de audio (carátulas, artista, etc.)
    -->
    <script src="https://cdn.jsdelivr.net/npm/music-metadata-browser@2.5.10/dist/music-metadata-browser.min.js"></script>

    <!-- NUEVO: Carga de Chart.js para gráficos de estadísticas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>


    <style>
        /* --- 1. Reseteo Básico y Variables --- */
        :root {
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --bg-main: #121212;
            --bg-surface: #1d1d1d;
            --bg-surface-hover: #2a2a2a;
            
            /* Colores Base (Se usan como fallback/default si no hay custom) */
            --bg-accent-base: #1e3a8a; 
            --bg-accent-hover-base: #1c327a;
            --text-accent-base: #60a5fa; 

            /* Colores Dinámicos: Usan el custom color o vuelven al base */
            --bg-accent: var(--custom-bg-accent, var(--bg-accent-base)); 
            --bg-accent-hover: var(--custom-bg-accent-hover, var(--bg-accent-hover-base));
            --text-accent: var(--custom-text-accent, var(--text-accent-base)); 
            
            --text-primary: #e0e0e0;
            --text-secondary: #b3b3b3;
            --border-color: #3a3a3a;
            
            --header-height: 60px;
            --player-height: 90px;
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 70px;
            --details-width: 300px;
            --border-radius: 8px;
            --transition-speed: 0.2s ease-in-out;
            --base-font-size: 16px; /* NUEVO: Variable para la escala de fuente */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* Evita el scroll en el body */
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: var(--base-font-size); /* MODIFICADO: Usar variable */
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            color: var(--text-primary);
        }

        ul {
            list-style: none;
        }

        button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-family: inherit;
        }
        
        button:disabled { /* Nuevo */
            opacity: 0.5;
            cursor: default;
        }

        /* Utilidad para ocultar texto visualmente pero mantenerlo accesible */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Estilo de los iconos SVG */
        .icon {
            width: 24px;
            height: 24px;
            stroke: var(--text-secondary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .icon-fill {
            fill: var(--text-secondary);
            stroke: none;
        }

        /* --- Utilidad --- */
        .hidden {
            display: none !important;
        }

        button:hover .icon,
        a:hover .icon {
            stroke: var(--text-primary);
        }
        
        button:hover .icon-fill {
            fill: var(--text-primary);
        }
        
        /* Estilo general para inputs */
        .text-input {
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all var(--transition-speed);
            width: 100%;
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 2px var(--bg-accent);
        }

        /* --- 2. Layout Principal (CSS Grid) --- */
        .app-container {
            display: grid;
            height: 100vh;
            width: 100%;
            grid-template-areas:
                "header header header"
                "sidebar main details"
                "player player player";
            grid-template-rows: var(--header-height) 1fr var(--player-height);
            grid-template-columns: var(--sidebar-width) 1fr var(--details-width);
            transition: grid-template-columns var(--transition-speed);
        }

        /* --- 3. Estilos de las Áreas --- */

        /* Header */
        .app-header {
            grid-area: header;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background-color: var(--bg-surface);
            border-bottom: 1px solid var(--border-color);
            position: relative; /* Mantenido por si acaso */
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative; /* Mantenido por si acaso */
            z-index: 1;
        }

        .header-title h1 {
            font-size: 1.25rem;
        }

        .search-form {
            position: relative;
            z-index: 1; /* Mantenido por si acaso */
        }

        .search-form .icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);
        }

        .search-input {
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px 12px 8px 36px; /* Espacio para el icono */
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all var(--transition-speed);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 2px var(--bg-accent);
        }

        /* Sidebar (Barra lateral) */
        .app-sidebar {
            grid-area: sidebar;
            background-color: var(--bg-surface);
            padding: 20px 0;
            overflow-y: auto; /* Scroll si el contenido es largo */
            overflow-x: hidden; /* Oculta el texto al colapsar */
            transition: all var(--transition-speed);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-toggle {
            display: none; /* Oculto en desktop, visible en mobile */
            padding: 8px;
        }

        .sidebar-header {
            padding: 0 20px 20px 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .sidebar-header h2 {
            font-size: 1.1rem;
            white-space: nowrap; /* Evita que el texto se parta */
        }
        
        .sidebar-header .icon { 
            width: 20px;
            height: 20px;
        }

        .sidebar-nav ul {
            display: flex;
            flex-direction: column;
        }
        
        #playlistList { /* Nuevo */
            max-height: 200px; 
            overflow-y: auto;
        }
        
        #playlistList .sidebar-nav-item { /* Nuevo */
            padding-left: 24px; /* Indentación */
        }
        
        #playlistList .sidebar-nav-item .icon { /* Nuevo */
            width: 20px;
            height: 20px;
        }
        
        /* Estilo para el contenedor de playlist en la sidebar */
        .playlist-sidebar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .playlist-sidebar-item a {
            flex-grow: 1;
            padding-right: 8px;
        }
        .playlist-sidebar-item button {
            flex-shrink: 0;
            padding: 8px;
            margin-right: 12px;
            border-radius: 4px;
        }
        .playlist-sidebar-item button:hover {
            background-color: var(--bg-surface-hover);
        }
        .playlist-sidebar-item .icon-edit {
            stroke: var(--text-accent);
            width: 20px;
            height: 20px;
        }


        .sidebar-nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            gap: 16px;
            color: var(--text-secondary);
            text-decoration: none;
            white-space: nowrap; /* Evita que el texto se parta */
            transition: all var(--transition-speed);
        }
        
        .sidebar-nav-item .icon {
            flex-shrink: 0; /* Evita que el icono se encoja */
        }

        .sidebar-nav-item:hover {
            background-color: var(--bg-surface-hover);
            color: var(--text-primary);
        }
        
        .sidebar-nav-item.active {
            color: var(--text-accent);
            border-left: 3px solid var(--text-accent);
            padding-left: 17px;
        }

        .sidebar-nav-item.active .icon {
            stroke: var(--text-accent);
        }
        
        .sidebar-nav-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 16px 20px;
        }

        /* Main Content (Contenido principal - Calendario) */
        .main-content {
            grid-area: main;
            overflow-y: auto; /* Permite scroll solo en esta área */
            padding: 24px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .calendar-header h2 {
            font-size: 1.75rem;
        }

        .calendar-nav button {
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px;
            margin-left: 8px;
            transition: all var(--transition-speed);
        }

        .calendar-nav button:hover {
            background-color: var(--bg-surface-hover);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden; /* Para que los bordes redondeados afecten a los hijos */
        }

        .calendar-day-header,
        .calendar-day {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        
        /* Elimina borde derecho del último elemento de cada fila */
        .calendar-day-header:nth-child(7n),
        .calendar-day:nth-child(7n) {
            border-right: none;
        }
        
        /* Elimina borde inferior de la última fila (asumiendo 6 filas) */
        .calendar-day:nth-child(n+36) { /* 7*5 + 1 = 36 */
             border-bottom: none;
        }


        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background-color: var(--bg-surface);
        }

        .calendar-day {
            min-height: 120px;
            background-color: var(--bg-surface);
            transition: all var(--transition-speed);
            cursor: pointer;
            /* NUEVO: Contenedor flex para apilar el número y los indicadores */
            display: flex; 
            flex-direction: column;
            gap: 5px;
            position: relative;
        }
        .day-number {
            flex-shrink: 0;
        }
        /* NUEVO: Estilos de indicadores */
        .indicators-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 5px; /* Separación de la fecha */
        }

        .content-dot {
            font-size: 0.7rem;
            line-height: 1;
            padding: 2px 4px;
            border-radius: 4px;
            background-color: var(--bg-surface-hover);
        }
        
        .content-dot.audio-dot {
            background-color: var(--bg-accent); /* Usa color de acento */
            color: var(--text-primary);
        }
        .content-dot.note-dot {
            background-color: #4ade80; /* Verde */
            color: var(--bg-main);
        }
        .content-dot.mood-dot {
            background-color: var(--text-accent); /* Usa color de acento */
            color: var(--text-primary);
        }
        
        /* Ajuste para que el día seleccionado muestre los indicadores sobre el color de fondo */
        .calendar-day.is-selected .content-dot {
            background-color: var(--bg-main);
            color: var(--text-primary);
            opacity: 0.9;
        }
        /* Fin NUEVO: Estilos de indicadores */

        
        .calendar-day:not(.is-disabled):hover {
            background-color: var(--bg-surface-hover);
        }
        
        .calendar-day.is-today {
            /* Mantenemos un tono azulado claro como base para "hoy" para visibilidad */
            background-color: #1e3a8a30; 
            font-weight: 700;
        }
        
        .calendar-day.is-selected {
            background-color: var(--bg-accent);
            box-shadow: inset 0 0 0 2px var(--text-accent);
        }
        
        .calendar-day.is-selected .day-number {
             color: var(--text-primary);
        }

        .calendar-day.is-disabled {
            background-color: var(--bg-main);
            color: #555;
            cursor: default;
        }
        
        .day-number {
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .calendar-day.is-today .day-number {
            color: var(--text-accent);
        }

        /* --- Estilos de la Vista de Biblioteca --- */
        #dropZone {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            color: var(--text-secondary);
            transition: all var(--transition-speed);
            margin-bottom: 24px;
        }

        #dropZone.drag-over {
            background-color: var(--bg-surface-hover);
            border-color: var(--text-accent);
        }

        .styled-file-btn {
            background-color: var(--bg-accent);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-speed);
            display: inline-block;
            margin-right: 16px;
        }
        
        .styled-file-btn:hover {
            background-color: var(--bg-accent-hover);
        }

        .styled-file-btn.btn-danger { 
            background-color: #991b1b;
        }
        .styled-file-btn.btn-danger:hover { 
            background-color: #7f1d1d;
        }
        
        #fileInput {
            display: none; /* Ocultamos el input real */
        }

        .library-list-container {
            margin-top: 24px;
            width: 100%;
            overflow-x: auto;
        }

        .library-table {
            width: 100%;
            border-collapse: collapse;
        }

        .library-table th,
        .library-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            vertical-align: middle; 
        }

        .library-table th {
            background-color: var(--bg-surface-hover);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .library-table th:first-child { /* Columna de Artwork */
             width: 60px;
        }

        .library-table td {
            font-size: 0.9rem;
        }
        
        .library-table .artwork-cell { 
            width: 60px;
            padding: 8px 16px;
        }
        
        .library-table .artwork-cell img { 
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            display: block;
            background-color: var(--bg-main);
        }
        
        .library-table .artwork-cell .icon { 
            width: 40px;
            height: 40px;
            padding: 8px;
            background-color: var(--bg-main);
            border-radius: 4px;
        }
        
        .library-table .track-title-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .library-table .play-lib-btn { 
            flex-shrink: 0;
            padding: 4px;
            border-radius: 50%;
        }
        
        .library-table .play-lib-btn:hover { 
            background-color: var(--bg-surface-hover);
        }
        
        .library-table .play-lib-btn .icon { 
            width: 20px;
            height: 20px;
            stroke: var(--text-accent);
        }

        .library-table .action-buttons .icon {
            width: 20px;
            height: 20px;
        }
        
        .library-table .action-buttons button {
            padding: 4px;
            border-radius: 4px;
        }
        
        .library-table .action-buttons button:hover {
            background-color: var(--bg-surface-hover);
        }
        
        .library-table .action-buttons .icon-delete:hover {
            stroke: #fb7185; /* Rojo para eliminar */
        }
        
        .library-table .action-buttons .icon-playlist:hover { 
            stroke: #a78bfa; /* Morado para playlist */
        }

        /* --- NUEVO: Estilos de la Vista de Configuración --- */
        .settings-card {
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
        }

        .settings-card h3 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .settings-card p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
            max-width: 600px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* NUEVO: Estilos para el selector de Color y Fuente */
        input[type="color"] {
            -webkit-appearance: none;
            appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            padding: 0;
            cursor: pointer;
            border-radius: var(--border-radius);
            overflow: hidden;
            background: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        
        /* Estilos para el slider de fuente */
        #fontScaleSlider {
            width: 150px;
            height: 8px;
            background: var(--border-color);
        }
        #fontScaleSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--text-accent);
            border-radius: 50%;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            opacity: 1; 
        }
        #fontScaleSlider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--text-accent);
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        
        /* --- NUEVO: Estilos para el selector de tema --- */
        .theme-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .theme-selector label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .theme-selector input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: var(--bg-main);
            margin: 0;
            font: inherit;
            color: var(--text-secondary);
            width: 1.15em;
            height: 1.15em;
            border: 0.15em solid var(--text-secondary);
            border-radius: 50%;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            transition: all var(--transition-speed);
        }

        .theme-selector input[type="radio"]::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em var(--bg-accent);
        }

        .theme-selector input[type="radio"]:checked {
            border-color: var(--bg-accent);
        }

        .theme-selector input[type="radio"]:checked::before {
            transform: scale(1);
        }

        .theme-selector label:hover {
            background-color: var(--bg-surface-hover);
        }
        
        .theme-selector input[type="radio"]:focus-visible {
             outline: 2px solid var(--text-accent);
             outline-offset: 2px;
        }

        /* --- NUEVO: Estilo para el Canvas de Partículas --- */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Detrás del contenido, delante del fondo */
            pointer-events: none; /* Para que no bloquee los clics */
        }

        /* --- MODIFICADO: Canvas del visualizador de vuelta al header --- */
        #headerWaveCanvas {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Ocupa todo el header */
            z-index: 0; /* Detrás del contenido del header */
            pointer-events: none;
            opacity: 0.6; /* Sutil */
        }


        /* Toggle Switch CSS (Conservado por si se usa en otro lado, pero oculto en config) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px; /* Ancho */
            height: 28px; /* Alto */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
            transition: .4s;
            border-radius: 28px; /* Alto */
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px; /* Círculo interior */
            width: 20px; /* Círculo interior */
            left: 3px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--bg-accent);
            border-color: var(--bg-accent);
        }
        
        input:checked + .toggle-slider:before {
            background-color: var(--text-primary);
            transform: translateX(22px); /* Desplazamiento */
        }

        /* --- NUEVO: Fondos Animados y Temas --- */
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Ajuste para que los fondos animados funcionen */
        .app-container.animated-theme {
            /* El fondo principal se define en el tema específico */
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
            
            /* Hacemos que los fondos de las superficies sean transparentes */
            --bg-main: transparent;
            --bg-surface: rgba(29, 29, 29, 0.7); /* Vidrio oscuro */
            --bg-surface-hover: rgba(42, 42, 42, 0.8);
            --border-color: rgba(58, 58, 58, 0.8);
            
            /* Los temas animados fuerzan sus propios colores */
            --bg-accent: var(--bg-accent-base); 
            --text-accent: var(--text-accent-base);
        }

        /* Efecto Frosted Glass (Esmerilado) */
        .app-container.animated-theme .app-header,
        .app-container.animated-theme .app-sidebar,
        .app-container.animated-theme .main-content,
        .app-container.animated-theme .details-panel,
        .app-container.animated-theme .app-player,
        .app-container.animated-theme .modal-content,
        .app-container.animated-theme .settings-card,
        .app-container.animated-theme .calendar-day {
             /* Comprobación de soporte para backdrop-filter */
             @supports (backdrop-filter: blur(10px)) {
                 backdrop-filter: blur(10px);
                 -webkit-backdrop-filter: blur(10px);
             }
             /* Fallback para navegadores que no soportan backdrop-filter */
             @supports not (backdrop-filter: blur(10px)) {
                 --bg-surface: rgba(29, 29, 29, 0.95); /* Más opaco */
                 --bg-surface-hover: rgba(42, 42, 42, 0.98);
             }
        }
        
        /* Tema 1: Océano Animado */
        .app-container.theme-ocean {
            background-image: linear-gradient(-45deg, #022c43, #053f5e, #115173, #0d3a50);
            --bg-accent-base: #2bb4d4;
            --bg-accent-hover-base: #229cb7;
            --text-accent-base: #5ef3ff;
            --text-primary: #f0f8ff;
            --text-secondary: #cce5ff;
        }

        /* Tema 2: Synthwave Animado */
        .app-container.theme-synthwave {
            background-image: linear-gradient(-45deg, #2c003e, #4f0147, #7c1158, #4f0147);
            --bg-accent-base: #f900a0;
            --bg-accent-hover-base: #d30088;
            --text-accent-base: #ff80d7;
            --text-primary: #f0e6f0;
            --text-secondary: #e0c2e0;
             --bg-surface: rgba(29, 20, 31, 0.7); /* Vidrio púrpura oscuro */
             --bg-surface-hover: rgba(42, 30, 44, 0.8);
             --border-color: rgba(80, 50, 80, 0.8);
        }
        
        /* NUEVO: Tema 3: Aurora Animado */
        .app-container.theme-aurora {
            background-image: linear-gradient(135deg, #37004d, #0d3d3d, #2a004f, #0d3d3d);
            --bg-accent-base: #00ff73; /* Verde neón */
            --bg-accent-hover-base: #00cc5c;
            --text-accent-base: #99ffaa;
            --text-primary: #f0f8ff;
            --text-secondary: #cce5ff;
            --bg-surface: rgba(18, 10, 20, 0.7);
        }

        /* NUEVO: Tema 4: Fuego Animado */
        .app-container.theme-fire {
            background-image: linear-gradient(-90deg, #5c0f00, #8a2a00, #a03c00, #ff4500);
            --bg-accent-base: #ff9900; 
            --bg-accent-hover-base: #cc7a00;
            --text-accent-base: #ffcc99;
            --text-primary: #fff0e0;
            --text-secondary: #ffd7b3;
            --bg-surface: rgba(30, 10, 5, 0.7);
        }
        
        /* NUEVO: Tema 5: Galaxia Animado */
        .app-container.theme-galaxy {
            background-image: linear-gradient(90deg, #1d003b, #001f3f, #3b003d, #001f3f);
            --bg-accent-base: #8a2be2; /* Azul violeta */
            --bg-accent-hover-base: #7823c9;
            --text-accent-base: #b3a3e9;
            --text-primary: #f8f0ff;
            --text-secondary: #e0c2ff;
            --bg-surface: rgba(15, 10, 25, 0.7);
        }


        /* --- NUEVO: Tema Claro --- */
        .app-container.light-theme {
            --bg-main: #f4f4f5; /* Gris claro */
            --bg-surface: #ffffff;
            --bg-surface-hover: #f9fafb;
            --bg-accent-base: #3b82f6; /* Azul más brillante */
            --bg-accent-hover-base: #2563eb;
            --text-accent-base: #2563eb;
            --text-primary: #18181b; /* Casi negro */
            --text-secondary: #52525b;
            --border-color: #e4e4e7;
            
            /* En tema claro, el custom color también se aplicará a estas variables base */
            --bg-accent: var(--custom-bg-accent, var(--bg-accent-base)); 
            --bg-accent-hover: var(--custom-bg-accent-hover, var(--bg-accent-hover-base));
            --text-accent: var(--custom-text-accent, var(--text-accent-base)); 
        }
        
        /* Ajustes para el tema claro */
        .app-container.light-theme .search-input {
             background-color: #f4f4f5; /* bg-main */
        }
        .app-container.light-theme .calendar-day.is-today {
             background-color: #dbeafe; /* Tono azulado claro */
        }
        .app-container.light-theme .calendar-day.is-disabled {
            background-color: #f4f4f5; /* bg-main */
            color: #a1a1aa;
        }
        .app-container.light-theme .audio-item,
        .app-container.light-theme .day-notes textarea {
            background-color: #f9fafb; /* Un poco más oscuro que surface */
        }
        .app-container.light-theme .day-notes textarea:focus {
             border-color: var(--text-accent);
        }
        .app-container.light-theme input[type="range"] {
             background: #e4e4e7; /* border-color */
        }
         .app-container.light-theme input[type="range"]::-webkit-slider-thumb {
             background: #333;
         }
         .app-container.light-theme input[type="range"]::-moz-range-thumb {
             background: #333;
         }
        .app-container.light-theme .toggle-slider {
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
        }
        .app-container.light-theme .toggle-slider:before {
            background-color: var(--text-secondary);
        }
        .app-container.light-theme input:checked + .toggle-slider {
            background-color: var(--bg-accent);
            border-color: var(--bg-accent);
        }
         .app-container.light-theme input:checked + .toggle-slider:before {
             background-color: var(--bg-surface);
         }

        /* --- Estilos de Modales y Notificaciones --- */
        .status-message {
            position: fixed;
            bottom: var(--player-height);
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px 24px;
            box-shadow: 0 4px 12px #00000080;
            z-index: 1001;
            transition: all 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        
        .status-message.show {
            bottom: calc(var(--player-height) + 20px);
            opacity: 1;
            visibility: visible;
        }
        
        .status-message.error {
            border-left: 4px solid #fb7185; /* Rojo */
        }
        
        .status-message.success {
            border-left: 4px solid #4ade80; /* Verde */
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px; /* Padding para evitar que el contenido toque los bordes */
        }

        .modal-content {
            background-color: var(--bg-surface);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            min-width: 300px;
            max-width: 600px; /* MODIFICADO: Más ancho para edición */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            width: 100%; /* Permitir que sea ancho completo en móviles */
        }
        
        @media (max-width: 640px) {
            .modal-content {
                max-width: 95%; /* Máximo ancho en móvil */
                padding: 16px;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-header h3 {
            font-size: 1.25rem;
        }
        
        .modal-close-btn .icon {
            width: 28px;
            height: 28px;
        }
        
        .modal-body { 
            font-size: 0.95rem;
            color: var(--text-secondary);
        }
        
        .modal-body p { 
            margin-bottom: 16px;
        }
        
        .modal-footer { 
            margin-top: 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .modal-footer button { 
             padding: 10px 16px;
        }
        
        .modal-footer .btn-secondary { 
            background-color: var(--bg-surface-hover);
            border-radius: var(--border-radius);
        }
        .modal-footer .btn-secondary:hover {
            background-color: #404040;
        }
        
        #modalPlaylistList { /* Nuevo */
            max-height: 200px; 
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        
        #modalPlaylistList .sidebar-nav-item:hover { /* Nuevo */
            background-color: var(--bg-surface-hover) !important;
        }
        
        #modalPlaylistList .sidebar-nav-item:disabled { /* Nuevo */
            background-color: var(--bg-main) !important;
        }
        
        /* NUEVO: Estilos de Edición de Playlist */
        #playlistEditContent {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* RESPONSIVE: Forzar apilamiento en móvil para el modal de edición */
        @media (max-width: 640px) {
            #playlistEditContent {
                flex-direction: column;
            }
            #playlistEditDetails {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            #playlistCoverPreview {
                width: 100%;
                max-width: 200px;
                height: 200px;
            }
        }
        
        #playlistEditDetails {
            flex-grow: 1;
        }
        
        #playlistCoverPreview {
            width: 150px;
            height: 150px;
            background-color: var(--bg-main);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
        }
        
        #playlistCoverPreview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #playlistCoverPreview .overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--transition-speed);
        }
        
        #playlistCoverPreview:hover .overlay {
            opacity: 1;
        }
        
        #playlistCoverPreview .overlay .icon {
            stroke: var(--text-primary);
            width: 32px;
            height: 32px;
        }
        
        /* Listado de Tracks en Edición */
        #playlistEditTrackList {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .edit-track-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: grab;
            transition: background-color 0.1s;
        }
        
        .edit-track-item:last-child {
            border-bottom: none;
        }
        
        .edit-track-item:hover {
            background-color: var(--bg-surface-hover);
        }
        
        .edit-track-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--text-accent);
        }

        .drag-handle {
            cursor: grab;
            margin-right: 10px;
            color: var(--text-secondary);
        }
        
        .track-title-edit {
            flex-grow: 1;
            font-size: 0.9rem;
        }
        
        .track-remove-btn {
            padding: 4px;
            margin-left: 10px;
        }
        .track-remove-btn .icon {
            stroke: #fb7185;
            width: 20px;
            height: 20px;
        }
        
        
        /* Textareas en modales */
        #playlistDescriptionInput {
            min-height: 80px;
            resize: vertical;
            background-color: var(--bg-main);
            margin-bottom: 10px;
        }


        /* Details Panel (Panel de detalles) */
        .details-panel {
            grid-area: details;
            background-color: var(--bg-surface);
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 24px;
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }

        .details-header {
            margin-bottom: 0; 
        }
        
        .details-header h2 {
            font-size: 1.25rem;
        }
        
        .details-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* NUEVO: Estilos para Mood Tracker */
        .day-mood h3 { 
            font-size: 1rem;
            color: var(--text-accent);
            margin-bottom: 12px;
        }
        
        .day-mood button {
            background: var(--bg-main);
            border-radius: 50%;
            padding: 8px;
            transition: all var(--transition-speed);
            opacity: 0.5;
            transform: scale(0.9);
            border: 2px solid transparent;
        }
        
        .day-mood button:hover {
            background: var(--bg-surface-hover);
            opacity: 0.8;
            transform: scale(1.0);
        }
        
        .day-mood button.selected {
            background: var(--bg-accent);
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 0 10px var(--text-accent);
            border-color: var(--text-accent);
        }
        
        /* NUEVO: Estilos para Resumen del día */
        .day-summary h3 {
            font-size: 1rem;
            color: var(--text-accent);
            margin-bottom: 12px;
        }


        .day-notes h3 { 
            font-size: 1rem;
            color: var(--text-accent);
            margin-bottom: 12px;
        }
        
        .day-notes textarea { 
            width: 100%;
            min-height: 120px;
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px;
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: 0.9rem;
            resize: vertical;
        }
        
        .day-notes textarea:focus {
             outline: none;
            border-color: var(--text-accent);
        }
        
        #saveNoteBtn { 
            margin-top: 12px;
            width: 100%;
        }


        .audio-list-day h3 {
            font-size: 1rem;
            color: var(--text-accent);
            margin-bottom: 16px;
        }

        .audio-list-day ul {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .audio-list-day .empty-list-message { 
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 20px 0;
        }

        .audio-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: var(--bg-main);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-speed);
        }
        
        .audio-item:hover {
            background-color: var(--bg-surface-hover);
        }
        
        .audio-item-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background-color: var(--bg-accent);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
        }
        
        .audio-item-icon img { 
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .audio-item-icon .icon {
            stroke: var(--text-primary);
        }
        
        .audio-item-info {
            overflow: hidden; /* Para truncar texto */
        }
        
        .audio-item-title {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .audio-item-duration {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .audio-item-play {
            margin-left: auto;
            padding: 4px;
            border-radius: 50%;
        }
        
        .audio-item-play:hover {
            background-color: var(--bg-surface-hover);
        }
        
        /* NUEVO: Estilo para el botón de remover asignación */
        .audio-item-remove { 
            flex-shrink: 0;
            padding: 4px;
            margin-left: 8px;
        }
        
        .audio-item-remove .icon {
            width: 20px;
            height: 20px;
            stroke: #fb7185; /* Rojo */
        }

        /* Player (Reproductor) */
        .app-player {
            grid-area: player;
            background-color: var(--bg-surface);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            gap: 24px;
        }

        /* 1. Información de la pista */
        .player-track-info {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 180px;
            flex-basis: 30%;
        }
        
        .track-cover {
            width: 56px;
            height: 56px;
            background-color: var(--bg-main);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
        }
        
        .track-cover .icon {
            width: 32px;
            height: 32px;
        }
        
        .track-cover img { 
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .track-details {
            overflow: hidden;
        }
        
        .track-title {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-artist {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 2. Controles centrales y progreso */
        .player-controls-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-basis: 40%;
            max-width: 600px;
        }
        
        .player-buttons {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .player-buttons button {
            padding: 8px;
            border-radius: 50%;
            transition: all var(--transition-speed);
        }
        
        .player-buttons button:hover {
            background-color: var(--bg-surface-hover);
        }
        
        .play-pause-btn {
            background-color: var(--bg-accent);
            border-radius: 50%;
            padding: 12px;
        }
        
        .play-pause-btn .icon {
            stroke: var(--text-primary);
            width: 28px;
            height: 28px;
        }

        .play-pause-btn:hover {
            background-color: var(--bg-accent-hover);
            transform: scale(1.05);
        }

        .progress-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Estilos para input[type=range] (barra de progreso y volumen) */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--bg-main);
            border-radius: 3px;
            cursor: pointer;
            outline: none;
        }
        
        /* Thumb (manejador) para Webkit */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: all var(--transition-speed);
            opacity: 0; /* Oculto por defecto, visible en hover */
        }
        
        input[type="range"]:hover::-webkit-slider-thumb {
            opacity: 1;
        }

        /* Thumb para Firefox */
        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--text-primary);
            border-radius: 50%;
            border: none;
            transition: all var(--transition-speed);
            opacity: 0;
        }
        
        input[type="range"]:hover::-moz-range-thumb {
            opacity: 1;
        }


        /* 3. Controles de volumen */
        .player-volume-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 180px;
            flex-basis: 30%;
            justify-content: flex-end;
        }
        
        .player-volume-controls button {
            padding: 4px;
        }

        .player-volume-controls input[type="range"] {
            width: 100px; /* Ancho fijo para la barra de volumen */
        }


        /* --- 4. Estado Colapsado --- */
        
        .app-container.sidebar-collapsed {
            grid-template-columns: var(--sidebar-collapsed-width) 1fr var(--details-width);
        }
        
        .app-container.sidebar-collapsed .sidebar-nav-text,
        .app-container.sidebar-collapsed .sidebar-header h2,
        .app-container.sidebar-collapsed .sidebar-nav-divider,
        .app-container.sidebar-collapsed .sidebar-header .icon { /* Ocultar icono '+' */
            display: none;
        }
        
        .app-container.sidebar-collapsed .sidebar-nav-item {
            justify-content: center;
            padding: 12px 0;
            width: 100%;
        }
        
        .app-container.sidebar-collapsed .sidebar-nav-item.active {
            border-left: none;
            border-right: 3px solid var(--text-accent);
            padding-left: 0; 
        }

        .app-container.sidebar-collapsed .sidebar-header {
            padding: 0;
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }


        /* --- 5. Diseño Responsivo (Móvil) --- */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-areas:
                    "header header"
                    "sidebar main"
                    "player player";
                grid-template-columns: var(--sidebar-collapsed-width) 1fr;
                grid-template-rows: var(--header-height) 1fr var(--player-height);
            }

            .details-panel {
                display: none; /* Ocultamos panel de detalles */
            }
            
            .sidebar-toggle {
                display: block;
            }

            .sidebar-nav-text,
            .sidebar-header h2,
            .sidebar-nav-divider,
            .sidebar-header .sidebar-header .icon {
                display: none;
            }

            .sidebar-nav-item {
                justify-content: center;
                padding: 12px 0;
                width: 100%;
            }
            
            .sidebar-nav-item.active {
                border-left: none;
                border-right: 3px solid var(--text-accent);
                padding-left: 0; 
            }

            .sidebar-header {
                padding: 0;
                display: flex;
                justify-content: center;
                margin-bottom: 20px;
            }
            
            .app-container.sidebar-collapsed {
                grid-template-columns: var(--sidebar-width) 1fr;
            }
            
            .app-container.sidebar-collapsed .sidebar-nav-text,
            .app-container.sidebar-collapsed .sidebar-header h2,
            .app-container.sidebar-collapsed .sidebar-nav-divider,
            .app-container.sidebar-collapsed .sidebar-header .icon {
                display: block; /* Mostramos el texto */
            }
            
            .app-container.sidebar-collapsed .sidebar-nav-item {
                justify-content: flex-start;
                padding: 12px 20px;
            }
            
             .app-container.sidebar-collapsed .sidebar-nav-item.active {
                 border-left: 3px solid var(--text-accent);
                 border-right: none;
                 padding-left: 17px;
             }

            .app-container.sidebar-collapsed .sidebar-header {
                padding: 0 20px 20px 20px;
                display: flex;
            }
            
            .player-track-info {
                min-width: unset;
                flex-basis: auto;
            }
            .track-artist {
                display: none; /* Ocultamos artista por espacio */
            }
            
            .player-volume-controls {
                display: none; /* Ocultamos controles de volumen en tablet/móvil */
            }
            
            .player-controls-center {
                flex-basis: auto;
                flex-grow: 1;
                max-width: none;
            }
        }
        
        @media (max-width: 640px) {
            .app-container {
                grid-template-areas:
                    "header"
                    "main"
                    "player";
                grid-template-columns: 1fr;
                grid-template-rows: var(--header-height) 1fr auto; /* Player height set to auto */
            }
            
            .app-sidebar,
            .details-panel {
                display: none; 
            }
            
            .sidebar-toggle {
                display: block; /* Botón para mostrar/ocultar sidebar overlay */
            }
            
            .app-header {
                padding: 0 16px;
            }
            
            .main-content {
                padding: 16px;
            }
            
            .calendar-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            /* Calendar Day Size adjustment */
            .calendar-day {
                min-height: 80px;
                padding: 8px;
            }
            
            .day-number {
                font-size: 0.9rem;
            }
            
            .calendar-day-header {
                font-size: 0.75rem;
                padding: 8px 4px;
            }
            
            /* Library table adjustments */
            .library-table th,
            .library-table td {
                padding: 8px 6px; /* Reduced padding */
                font-size: 0.8rem;
            }
            .library-table th:nth-child(5), /* Tamaño */
            .library-table td:nth-child(5) {
                display: none;
            }
            .library-table th:nth-child(6), /* Formato */
            .library-table td:nth-child(6) {
                display: none;
            }

            /* Player adjustments */
            .app-player {
                padding: 0 16px 16px 16px; /* Padding bottom to prevent clash */
                flex-wrap: wrap;
                height: auto; 
                gap: 8px; /* Reduced gap */
            }
            
            .player-track-info {
                order: 1; /* Arriba */
                flex-basis: 70%;
                padding-top: 12px;
            }
            
            .track-cover {
                width: 40px;
                height: 40px;
            }
            
            .track-cover .icon {
                width: 24px;
                height: 24px;
            }
            
            .player-buttons {
                order: 2; /* Arriba a la derecha */
                flex-basis: 30%;
                justify-content: flex-end;
                padding-top: 12px;
                gap: 8px; /* Reduced button gap */
            }
            
            .play-pause-btn {
                padding: 8px; /* Smaller main button */
            }
            
            .play-pause-btn .icon {
                width: 20px;
                height: 20px;
            }
            
            .prev-btn, .next-btn {
                display: none; /* Hide navigation buttons on smallest screens */
            }
            
            .player-controls-center {
                order: 3; /* Abajo del todo */
                flex-basis: 100%;
                gap: 4px; /* Reduced gap for progress bar */
            }
            .progress-bar-container {
                margin-top: 0;
            }
        }

        /* NUEVO: Estilos para la Vista de Estadísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .stats-card {
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }

        .stats-card h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stats-card .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-accent);
        }

        .stats-card .stats-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: auto;
        }
        
        /* NUEVO: Estilos para el Canvas de Estadísticas */
        #moodChartCanvas {
            max-height: 400px; /* Limitar la altura para que no ocupe toda la pantalla */
        }
        /* FIN NUEVO: Estilos para la Vista de Estadísticas */

    </style>
</head>
<body class="app-container">

    <!-- NUEVO: Canvas para partículas reactivas -->
    <canvas id="particleCanvas"></canvas>

    <!-- 
      Definiciones de Iconos SVG
      Usamos un <defs> para definir todos los iconos una vez
      y reutilizarlos con <use href="#icon-name">.
    -->
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <symbol id="icon-menu" viewBox="0 0 24 24">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </symbol>
            <symbol id="icon-search" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </symbol>
            <symbol id="icon-calendar" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </symbol>
            <symbol id="icon-library" viewBox="0 0 24 24">
                <path d="M19 2H5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"></path>
                <path d="M12 11.55C10.64 10.32 9 11.23 9 13v2.3c0 .88.89 1.45 1.69.98l1.32-1.01"></path>
                <path d="M15 11.55C13.64 10.32 12 11.23 12 13v2.3c0 .88.89 1.45 1.69.98l1.32-1.01"></path>
            </symbol>
            <symbol id="icon-playlist" viewBox="0 0 24 24">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24"> 
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </symbol>
            <symbol id="icon-chevron-left" viewBox="0 0 24 24">
                <polyline points="15 18 9 12 15 6"></polyline>
            </symbol>
            <symbol id="icon-chevron-right" viewBox="0 0 24 24">
                <polyline points="9 18 15 12 9 6"></polyline>
            </symbol>
            <symbol id="icon-music" viewBox="0 0 24 24">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </symbol>
            <symbol id="icon-play-circle" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <polygon points="10 8 16 12 10 16 10 8"></polygon>
            </symbol>
            <symbol id="icon-play" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </symbol>
            <symbol id="icon-pause" viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </symbol>
            <symbol id="icon-skip-back" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="19 20 9 12 19 4 19 20"></polygon>
                <line x1="5" y1="19" x2="5" y2="5"></line>
            </symbol>
            <symbol id="icon-skip-forward" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 4 15 12 5 20 5 4"></polygon>
                <line x1="19" y1="5" x2="19" y2="19"></line>
            </symbol>
            <symbol id="icon-volume-2" viewBox="0 0 24 24">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </symbol>
            <symbol id="icon-volume-x" viewBox="0 0 24 24">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <line x1="23" y1="9" x2="17" y2="15"></line>
                <line x1="17" y1="9" x2="23" y2="15"></line>
            </symbol>
            <symbol id="icon-upload" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </symbol>
            <symbol id="icon-trash" viewBox="0 0 24 24">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </symbol>
            <symbol id="icon-info" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </symbol>
            <symbol id="icon-x" viewBox="0 0 24 24">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </symbol>
            <!-- NUEVO: Icono de Configuración -->
            <symbol id="icon-settings" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </symbol>
            <!-- NUEVO: Icono para eliminar asignaciones/elementos -->
            <symbol id="icon-minus-circle" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </symbol>
            <!-- NUEVO: Icono de Edición (Pencil) -->
            <symbol id="icon-edit-2" viewBox="0 0 24 24">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </symbol>
            <!-- NUEVO: Icono de Mover (Drag Handle) -->
            <symbol id="icon-move" viewBox="0 0 24 24">
                <polyline points="5 9 2 12 5 15"></polyline>
                <polyline points="9 5 12 2 15 5"></polyline>
                <polyline points="15 19 12 22 9 19"></polyline>
                <polyline points="19 9 22 12 19 15"></polyline>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <line x1="12" y1="2" x2="12" y2="22"></line>
            </symbol>
            <!-- NUEVO: Icono de Estadísticas -->
            <symbol id="icon-bar-chart-2" viewBox="0 0 24 24">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
            </symbol>
            <!-- NUEVO: Icono de Información -->
            <symbol id="icon-help-circle" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </symbol>
        </defs>
    </svg>


    <!-- ---- HEADER (Barra superior) ---- -->
    <header class="app-header" role="banner">
        <div class="header-title">
            <button id="sidebarToggleBtn" class="sidebar-toggle" aria-label="Alternar barra lateral" aria-expanded="true">
                <svg class="icon"><use href="#icon-menu"></use></svg>
            </button>
            <h1>Datefy</h1>
        </div>
        
        <form class="search-form" role="search" onsubmit="event.preventDefault();">
            <svg class="icon"><use href="#icon-search"></use></svg>
            <input type="search" id="searchInput" class="search-input" placeholder="Buscar en la biblioteca...">
        </form>

        <!-- MODIFICADO: Canvas de vuelta al header -->
        <canvas id="headerWaveCanvas"></canvas>
    </header>

    <!-- ---- SIDEBAR (Navegación izquierda) ---- -->
    <nav class="app-sidebar" id="appSidebar" role="navigation" aria-label="Navegación principal">
        
        <header class="sidebar-header">
            <h2>Biblioteca</h2>
        </header>

        <nav class="sidebar-nav">
            <ul>
                <!-- La clase 'active' se aplica dinámicamente -->
                <li>
                    <a href="#" class="sidebar-nav-item active" data-view="calendar">
                        <svg class="icon"><use href="#icon-calendar"></use></svg>
                        <span class="sidebar-nav-text">Calendario</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-nav-item" data-view="library">
                        <svg class="icon"><use href="#icon-library"></use></svg>
                        <span class="sidebar-nav-text">Toda la Música</span>
                    </a>
                </li>
                <!-- NUEVO: Enlace a Estadísticas -->
                <li>
                    <a href="#" class="sidebar-nav-item" data-view="statistics">
                        <svg class="icon"><use href="#icon-bar-chart-2"></use></svg>
                        <span class="sidebar-nav-text">Estadísticas</span>
                    </a>
                </li>
                <!-- NUEVO: Enlace a Configuración -->
                <li>
                    <a href="#" class="sidebar-nav-item" data-view="settings">
                        <svg class="icon"><use href="#icon-settings"></use></svg>
                        <span class="sidebar-nav-text">Configuración</span>
                    </a>
                </li>
                <!-- NUEVO: Enlace a Acerca de -->
                <li>
                    <a href="#" class="sidebar-nav-item" data-view="about">
                        <svg class="icon"><use href="#icon-help-circle"></use></svg>
                        <span class="sidebar-nav-text">Acerca de</span>
                    </a>
                </li>
                
                <div class="sidebar-nav-divider"></div>
                
                <header class="sidebar-header" style="padding-top: 10px;">
                    <h2>Mis Playlists</h2>
                    <button id="newPlaylistBtn" aria-label="Crear nueva playlist">
                        <svg class="icon"><use href="#icon-plus"></use></svg>
                    </button>
                </header>
                    
                <!-- Las playlists se generan dinámicamente -->
                <ul id="playlistList">
                    <!-- Ejemplo de estado vacío -->
                    <li>
                        <a href="#" class="sidebar-nav-item" style="color: var(--text-secondary); opacity: 0.7;">
                            <span class="sidebar-nav-text" style="padding-left: 24px;">No hay playlists.</span>
                        </a>
                    </li>
                </ul>
            </ul>
        </nav>
    </nav>

    <!-- ---- MAIN CONTENT (Calendario) ---- -->
    <main class="main-content" id="mainContent" role="main" tabindex="-1">

        <!-- ELIMINADO: Visualizador Principal Grande -->
        <!-- <canvas id="mainVisualizerCanvas"></canvas> -->

        <!-- VISTA DE CALENDARIO -->
        <div id="calendarView">
            <div class="calendar-header">
                <h2 id="calendarMonthYear">Octubre 2025</h2>
                <div class="calendar-nav">
                    <button id="prevMonthBtn" aria-label="Mes anterior">
                        <svg class="icon"><use href="#icon-chevron-left"></use></svg>
                    </button>
                    <button id="nextMonthBtn" aria-label="Mes siguiente">
                        <svg class="icon"><use href="#icon-chevron-right"></use></svg>
                    </button>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid" role="grid" aria-labelledby="calendarMonthYear">
                <!-- Fila de cabecera de días (Estática) -->
                <div class="calendar-day-header" role="columnheader">Lun</div>
                <div class="calendar-day-header" role="columnheader">Mar</div>
                <div class="calendar-day-header" role="columnheader">Mié</div>
                <div class="calendar-day-header" role="columnheader">Jue</div>
                <div class="calendar-day-header" role="columnheader">Vie</div>
                <div class="calendar-day-header" role="columnheader">Sáb</div>
                <div class="calendar-day-header" role="columnheader">Dom</div>

                <!-- 
                  Los días del calendario se generan dinámicamente por JS.
                  Este contenido se borrará al cargar.
                -->
            </div>
        </div>

        <!-- VISTA DE BIBLIOTECA (Nueva) -->
        <div id="libraryView" class="hidden">
            <header class="calendar-header"> <!-- Reutilizando estilo -->
                <h2>Toda la Música</h2>
                <div>
                    <label for="fileInput" class="styled-file-btn">
                        Seleccionar Archivos
                    </label>
                    <input type="file" id="fileInput" multiple accept="audio/*">
                </div>
            </header>

            <div id="dropZone">
                <svg class="icon" style="width: 48px; height: 48px; margin-bottom: 16px;"><use href="#icon-upload"></use></svg>
                <p>Arrastra y suelta tus archivos de audio aquí</p>
                <small>(Formatos permitidos: mp3, wav, ogg, flac...)</small>
            </div>
            
            <div class="library-list-container">
                <table class="library-table">
                    <thead>
                        <tr>
                            <th><!-- Artwork --></th>
                            <th>Título</th>
                            <th>Artista</th>
                            <th>Duración</th>
                            <th>Tamaño</th>
                            <th>Formato</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="libraryTbody">
                        <!-- Las filas se generan dinámicamente por JS -->
                    </tbody>
                </table>
            </div>

        </div> <!-- Fin #libraryView -->
        
        <!-- NUEVO: VISTA DE ESTADÍSTICAS -->
        <div id="statisticsView" class="hidden">
            <header class="calendar-header">
                <h2>Estadísticas de Uso</h2>
            </header>
            <p>Aquí puedes ver un resumen de cómo has utilizado tu reproductor y las tendencias de tu estado de ánimo.</p>

            <div class="stats-grid">
                <!-- Tarjeta 1: Total Audios Cargados -->
                <div class="stats-card">
                    <h4>Total de Archivos</h4>
                    <span class="stats-value" id="statsTotalFiles">0</span>
                    <span class="stats-detail">Archivos de música en la biblioteca</span>
                </div>

                <!-- Tarjeta 2: Días con Mood Registrado -->
                <div class="stats-card">
                    <h4>Días Registrados</h4>
                    <span class="stats-value" id="statsTotalMoodDays">0</span>
                    <span class="stats-detail">Días con estado de ánimo guardado</span>
                </div>

                <!-- Tarjeta 3: Duración Total Asignada -->
                <div class="stats-card">
                    <h4>Duración Total Asignada</h4>
                    <span class="stats-value" id="statsTotalAssignedDuration">0:00</span>
                    <span class="stats-detail">Tiempo total en el calendario</span>
                </div>
                
                <!-- Tarjeta 4: Playlists Creadas -->
                <div class="stats-card">
                    <h4>Playlists Creadas</h4>
                    <span class="stats-value" id="statsTotalPlaylists">0</span>
                    <span class="stats-detail">Colecciones personales de música</span>
                </div>
            </div>

            <!-- Sección de Análisis Detallado -->
            <h3 style="margin-top: 40px; font-size: 1.5rem; color: var(--text-accent);">Análisis de Estado de Ánimo</h3>
            <p style="color: var(--text-secondary);">Distribución de los estados de ánimo registrados.</p>
            
            <div id="moodDistribution" style="background-color: var(--bg-surface); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 20px; min-height: 200px; margin-top: 10px;">
                <!-- CANVAS PARA EL GRÁFICO DE ESTADO DE ÁNIMO -->
                <canvas id="moodChartCanvas"></canvas>
            </div>
            
        </div> <!-- Fin #statisticsView -->

        <!-- NUEVO: VISTA ACERCA DE -->
        <div id="aboutView" class="hidden">
            <header class="calendar-header">
                <h2>Acerca de Mi Reproductor</h2>
            </header>
            <div class="settings-card">
                <h3>Detalles de la Aplicación</h3>
                <p>Esta es una aplicación web progresiva y local, diseñada para gestionar tu biblioteca de audio y asignaciones de calendario personal sin necesidad de servidores externos.</p>
                <div class="setting-item">
                    <span class="setting-item-label">Versión</span>
                    <span style="color: var(--text-primary);">1.2.0 (Alpha)</span>
                </div>
                <div class="setting-item">
                    <span class="setting-item-label">Almacenamiento de Datos</span>
                    <span style="color: var(--text-primary);">IndexedDB (Local)</span>
                </div>
                <h3 style="margin-top: 30px;">Licencia y Créditos</h3>
                <p>Diseñado y desarrollado por Gemini (Google). Los íconos son provistos por Lucide Icons (Licencia MIT).</p>
            </div>
        </div> <!-- Fin #aboutView -->

        <!-- VISTA DE CONFIGURACIÓN -->
        <div id="settingsView" class="hidden">
            <header class="calendar-header">
                <h2>Configuración</h2>
            </header>

            <!-- Card de Apariencia -->
            <div class="settings-card">
                <h3>Apariencia</h3>
                <p>Personaliza el aspecto de la aplicación.</p>
                
                <!-- Opciones de Tema (MODIFICADO) -->
                <div class="setting-item">
                    <span class="setting-item-label">Seleccionar Tema</span>
                </div>
                <div class="theme-selector" role="radiogroup" aria-labelledby="theme-label">
                    <label>
                        <input type="radio" name="theme" value="default-dark" checked>
                        Oscuro (Defecto)
                    </label>
                    <label>
                        <input type="radio" name="theme" value="light-theme">
                        Claro
                    </label>
                    <label>
                        <input type="radio" name="theme" value="theme-ocean">
                        Océano (Animado)
                    </label>
                    <label>
                        <input type="radio" name="theme" value="theme-synthwave">
                        Synthwave (Animado)
                    </label>
                    <label>
                        <input type="radio" name="theme" value="theme-aurora">
                        Aurora (Animado)
                    </label>
                    <label>
                        <input type="radio" name="theme" value="theme-fire">
                        Fuego (Animado)
                    </label>
                    <label>
                        <input type="radio" name="theme" value="theme-galaxy">
                        Galaxia (Animado)
                    </label>
                </div>
                
                <!-- NUEVO: Selector de Color de Acento -->
                <div class="setting-item" style="margin-top: 20px;">
                    <label for="accentColorInput" class="setting-item-label">Color de Acento Principal</label>
                    <input type="color" id="accentColorInput" value="#60a5fa" aria-label="Seleccionar color de acento">
                </div>
                
                <!-- NUEVO: Slider de Escala de Fuente -->
                <div class="setting-item">
                    <label for="fontScaleSlider" class="setting-item-label">Escala de Fuente (<span id="fontScaleValue">100</span>%)</label>
                    <input type="range" id="fontScaleSlider" min="90" max="110" value="100" aria-label="Ajustar escala de fuente">
                </div>

                <!-- NUEVO: Interruptor para partículas -->
                <div class="setting-item" style="margin-top: 16px;">
                    <!-- MODIFICADO: Texto de la etiqueta -->
                    <label for="particleToggle" class="setting-item-label">Activar Visualizadores de Audio</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="particleToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Card de Datos -->
            <div class="settings-card">
                <h3>Gestión de Datos</h3>
                <p>Administra los datos almacenados en tu navegador.</p>
                <div class="setting-item">
                    <span class="setting-item-label">Borrar Biblioteca</span>
                    <button id="clearLibraryBtn" class="styled-file-btn btn-danger">Borrar Todo</button>
                </div>
            </div>

        </div> <!-- Fin #settingsView -->
    </main>

    <!-- ---- DETAILS PANEL (Info del día) ---- -->
    <aside class="details-panel" id="detailsPanel" role="complementary" aria-labelledby="details-heading">
        <div class="details-header">
            <!-- Actualizado dinámicamente con JS -->
            <h2 id="details-heading">Detalles del Día</h2>
            <p id="details-date">--</p>
        </div>
        
        <!-- NUEVO: Mood Tracker -->
        <div class="day-mood">
            <h3>Mi Estado de Ánimo</h3>
            <div id="moodSelector" style="display: flex; gap: 10px; font-size: 2rem; justify-content: space-around;">
                <!-- Emojis serán botones -->
                <button data-mood="5" aria-label="Excelente">😍</button>
                <button data-mood="4" aria-label="Bien">😊</button>
                <button data-mood="3" aria-label="Neutral">😐</button>
                <button data-mood="2" aria-label="Mal">😔</button>
                <button data-mood="1" aria-label="Pésimo">😭</button>
            </div>
            <p id="currentMoodDisplay" style="text-align: center; margin-top: 10px; font-size: 0.9rem; color: var(--text-accent);">No seleccionado</p>
        </div>
        
        <!-- NUEVO: Resumen del Día -->
        <div class="day-summary">
            <h3>Resumen del Día</h3>
            <ul id="daySummaryList" style="list-style: disc; padding-left: 20px; font-size: 0.9rem; color: var(--text-secondary);">
                <li><strong style="color: var(--text-primary);">Total Audios:</strong> <span id="summaryTotalAudios">0</span></li>
                <li><strong style="color: var(--text-primary);">Duración Total:</strong> <span id="summaryTotalDuration">0:00</span></li>
                <li><strong style="color: var(--text-primary);">Estado de Ánimo:</strong> <span id="summaryMoodStatus">No registrado</span></li>
            </ul>
        </div>
        <!-- FIN NUEVO RESUMEN -->

        
        <div class="day-notes">
            <h3>Notas del Día</h3>
            <textarea id="dayNotesText" placeholder="Escribe tus notas para este día..."></textarea>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button id="saveNoteBtn" class="styled-file-btn" style="flex-grow: 1;">Guardar Nota</button>
                <button id="deleteNoteBtn" class="styled-file-btn btn-danger" style="flex-shrink: 0; width: auto;">Borrar</button>
            </div>
        </div>
        
        <div class="audio-list-day">
            <h3>Audios Asignados</h3>
            
            <!-- Lista generada dinámicamente -->
            <ul id="audioListDay">
                <li class="empty-list-message">No hay audios asignados a este día.</li>
            </ul>
        </div>
    </aside>

    <!-- ---- FOOTER (Reproductor) ---- -->
    <footer class="app-player" id="appPlayer" role="region" aria-label="Reproductor multimedia">
        
        <!-- Info de la pista actual -->
        <div class="player-track-info">
            <div class="track-cover" id="trackCover">
                <svg class="icon"><use href="#icon-music"></use></svg>
            </div>
            <div class="track-details">
                <div class="track-title" id="trackTitle">--</div>
                <div class="track-artist" id="trackArtist">--</div>
            </div>
        </div>
        
        <!-- Controles centrales y progreso -->
        <div class="player-controls-center">
            <div class="player-buttons">
                <button id="prevBtn" class="prev-btn" aria-label="Pista anterior">
                    <svg class="icon icon-fill"><use href="#icon-skip-back"></use></svg>
                </button>
                
                <button id="playPauseBtn" class="play-pause-btn" aria-label="Reproducir">
                    <!-- Cambia icono a #icon-pause cuando está sonando -->
                    <svg class="icon icon-fill" id="playPauseIcon"><use href="#icon-play"></use></svg>
                </button>
                
                <button id="nextBtn" class="next-btn" aria-label="Pista siguiente">
                    <svg class="icon icon-fill"><use href="#icon-skip-forward"></use></svg>
                </button>
            </div>
            <div class="progress-bar-container">
                <span id="currentTime">0:00</span>
                <input type="range" id="progressSlider" class="progress-slider" min="0" max="100" value="0" aria-label="Progreso de la pista">
                <span id="totalTime">0:00</span>
            </div>
        </div>

        <!-- Controles de volumen -->
        <div class="player-volume-controls">
            <button id="muteBtn" aria-label="Silenciar">
                <!-- Cambia icono a #icon-volume-x cuando está silenciado -->
                <svg class="icon" id="volumeIcon"><use href="#icon-volume-2"></use></svg>
            </button>
            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="1" aria-label="Control de volumen">
        </div>
        
        <!-- Elemento de audio (oculto) -->
        <audio id="audioElement" src=""></audio>
    </footer>

    <!-- ---- MODALES Y NOTIFICACIONES ---- -->

    <!-- Mensaje de Estado/Error -->
    <div id="statusMessage" class="status-message">
        <span id="statusMessageText"></span>
    </div>

    <!-- Modal: Asignar al Día -->
    <div id="assignDayModal" class="modal-overlay hidden">
        <div class="modal-content">
            <header class="modal-header">
                <h3>Asignar Audio al Calendario</h3>
                <button class="modal-close-btn" data-modal-id="assignDayModal" aria-label="Cerrar">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </button>
            </header>
            <div class="modal-body">
                <p>El audio se asignará al día seleccionado actualmente en el calendario:</p>
                <p style="font-weight: 600; color: var(--text-primary);" id="assignModalDate">Por favor, selecciona un día primero.</p>
                <p>Audio ID: <span id="audioToAssignId"></span></p>
                <button id="saveAssignmentBtn" class="styled-file-btn" style="margin-top: 16px;">Asignar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Ver Metadatos -->
    <div id="metadataModal" class="modal-overlay hidden">
        <div class="modal-content">
            <header class="modal-header">
                <h3>Metadatos del Archivo</h3>
                <button class="modal-close-btn" data-modal-id="metadataModal" aria-label="Cerrar">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </button>
            </header>
            <div class="modal-body" id="metadataModalBody">
                <!-- Contenido generado por JS -->
            </div>
        </div>
    </div>
    
    <!-- Modal: Añadir a Playlist (Actualizado) -->
    <div id="addPlaylistModal" class="modal-overlay hidden">
        <div class="modal-content">
            <header class="modal-header">
                <h3>Añadir a Playlist</h3>
                <button class="modal-close-btn" data-modal-id="addPlaylistModal" aria-label="Cerrar">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </button>
            </header>
            <div class="modal-body" id="addPlaylistModalBody">
                <p>Añadir audio (ID: <span id="audioToPlaylistId"></span>) a:</p>
                <ul id="modalPlaylistList">
                    <!-- Lista de playlists se genera aquí -->
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Modal: Confirmar Eliminación (Nuevo) -->
    <div id="deleteConfirmModal" class="modal-overlay hidden">
        <div class="modal-content">
            <header class="modal-header">
                <h3>Confirmar Eliminación</h3>
                <button class="modal-close-btn" data-modal-id="deleteConfirmModal" aria-label="Cerrar">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </button>
            </header>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres eliminar este archivo de la biblioteca? Esta acción no se puede deshacer.</p>
                <p id="trackToDeleteName" style="font-weight: 600; color: var(--text-primary);"></p>
            </div>
            <footer class="modal-footer">
                <button class="btn-secondary modal-close-btn" data-modal-id="deleteConfirmModal">Cancelar</button>
                <button id="confirmDeleteBtn" class="styled-file-btn btn-danger">Eliminar</button>
            </footer>
        </div>
    </div>
    
    <!-- Modal: Crear Nueva Playlist (Nuevo) -->
    <div id="createPlaylistModal" class="modal-overlay hidden">
        <div class="modal-content">
            <header class="modal-header">
                <h3>Crear Nueva Playlist</h3>
                <button class="modal-close-btn" data-modal-id="createPlaylistModal" aria-label="Cerrar">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </button>
            </header>
            <div class="modal-body">
                <p>Introduce un nombre para tu nueva playlist.</p>
                <input type="text" id="newPlaylistNameInput" class="text-input" placeholder="Nombre de la playlist...">
            </div>
            <footer class="modal-footer">
                <button class="btn-secondary modal-close-btn" data-modal-id="createPlaylistModal">Cancelar</button>
                <button id="saveNewPlaylistBtn" class="styled-file-btn">Crear</button>
            </footer>
        </div>
    </div>
    
    <!-- NUEVO: Modal de Edición de Playlist -->
    <div id="editPlaylistModal" class="modal-overlay hidden">
        <div class="modal-content">
            <header class="modal-header">
                <h3>Editar Playlist: <span id="editPlaylistNameTitle"></span></h3>
                <button class="modal-close-btn" data-modal-id="editPlaylistModal" aria-label="Cerrar">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </button>
            </header>
            <div class="modal-body">
                <div id="playlistEditContent">
                    <!-- Columna de Detalles y Cover -->
                    <div id="playlistEditDetails">
                        <label>Carátula (Click para subir):</label>
                        <div id="playlistCoverPreview">
                            <input type="file" id="coverFileInput" accept="image/*" class="visually-hidden">
                            <div id="playlistCoverImageContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                <svg class="icon" style="width: 50px; height: 50px;"><use href="#icon-music"></use></svg>
                            </div>
                            <div class="overlay">
                                <svg class="icon"><use href="#icon-upload"></use></svg>
                                <span>Cambiar</span>
                            </div>
                        </div>
                        
                        <label for="playlistNameInput">Nombre:</label>
                        <input type="text" id="playlistNameInput" class="text-input" style="margin-bottom: 10px;">
                        
                        <label for="playlistDescriptionInput">Descripción:</label>
                        <textarea id="playlistDescriptionInput" class="text-input" placeholder="Añade una descripción..."></textarea>
                        
                    </div>
                    
                    <!-- Columna de Pistas -->
                    <div style="flex-grow: 2;">
                        <h4>Pistas en la Playlist (Arrastrar para reordenar)</h4>
                        <ul id="playlistEditTrackList" data-playlist-id="">
                            <li class="empty-list-message">Cargando pistas...</li>
                        </ul>
                    </div>
                </div>
            </div>
            <footer class="modal-footer">
                <button class="btn-secondary modal-close-btn" data-modal-id="editPlaylistModal">Cancelar</button>
                <button id="savePlaylistEditBtn" class="styled-file-btn">Guardar Cambios</button>
            </footer>
        </div>
    </div>


    <!-- NUEVO: Modal: Confirmar Borrado Total -->
    <div id="clearLibraryConfirmModal" class="modal-overlay hidden">
        <div class="modal-content">
            <header class="modal-header">
                <h3>¡Acción Irreversible!</h3>
                <button class="modal-close-btn" data-modal-id="clearLibraryConfirmModal" aria-label="Cerrar">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </button>
            </header>
            <div class="modal-body">
                <p>¿Estás absolutamente seguro? Esto eliminará <strong>toda</strong> tu biblioteca de música, playlists, notas y asignaciones del calendario.</p>
                <p><strong>Esta acción no se puede deshacer.</strong></p>
            </div>
            <footer class="modal-footer">
                <button class="btn-secondary modal-close-btn" data-modal-id="clearLibraryConfirmModal">Cancelar</button>
                <button id="confirmClearLibraryBtn" class="styled-file-btn btn-danger">Sí, borrar todo</button>
            </footer>
        </div>
    </div>

    
    <script>
        // Espera a que todo el DOM esté cargado
        document.addEventListener('DOMContentLoaded', () => {

            // --- Referencias a elementos del DOM ---
            const body = document.body;
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            const mainContent = document.getElementById('mainContent');
            const searchInput = document.getElementById('searchInput');
            
            // Vistas
            const calendarView = document.getElementById('calendarView');
            const libraryView = document.getElementById('libraryView');
            const statisticsView = document.getElementById('statisticsView'); // NUEVO
            const aboutView = document.getElementById('aboutView'); // NUEVO
            const settingsView = document.getElementById('settingsView'); // EXISTENTE
            const sidebarLinks = document.querySelectorAll('.sidebar-nav-item[data-view]');

            // Biblioteca
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.getElementById('dropZone');
            const libraryTbody = document.getElementById('libraryTbody');
            
            // Playlists (Nuevo)
            const newPlaylistBtn = document.getElementById('newPlaylistBtn');
            const createPlaylistModal = document.getElementById('createPlaylistModal');
            const newPlaylistNameInput = document.getElementById('newPlaylistNameInput');
            const saveNewPlaylistBtn = document.getElementById('saveNewPlaylistBtn');
            const playlistList = document.getElementById('playlistList');
            const modalPlaylistList = document.getElementById('modalPlaylistList');
            
            // Modales y Notificaciones
            const statusMessage = document.getElementById('statusMessage');
            const statusMessageText = document.getElementById('statusMessageText');
            const assignDayModal = document.getElementById('assignDayModal');
            const metadataModal = document.getElementById('metadataModal');
            const addPlaylistModal = document.getElementById('addPlaylistModal'); 
            const deleteConfirmModal = document.getElementById('deleteConfirmModal'); 
            const audioToAssignId = document.getElementById('audioToAssignId');
            const assignModalDate = document.getElementById('assignModalDate');
            const audioToPlaylistId = document.getElementById('audioToPlaylistId'); 
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn'); 
            const trackToDeleteName = document.getElementById('trackToDeleteName'); 
            const metadataModalBody = document.getElementById('metadataModalBody');
            const modalCloseBtns = document.querySelectorAll('.modal-close-btn');
            
            // NUEVO: Configuración
            const themeToggle = document.getElementById('themeToggle'); 
            const themeSelector = document.querySelector('.theme-selector'); 
            const themeRadioButtons = document.querySelectorAll('.theme-selector input[name="theme"]'); 
            const particleToggle = document.getElementById('particleToggle'); 
            const clearLibraryBtn = document.getElementById('clearLibraryBtn');
            const clearLibraryConfirmModal = document.getElementById('clearLibraryConfirmModal');
            const confirmClearLibraryBtn = document.getElementById('confirmClearLibraryBtn');
            
            // NUEVO: Customization Refs
            const accentColorInput = document.getElementById('accentColorInput');
            const fontScaleSlider = document.getElementById('fontScaleSlider');
            const fontScaleValue = document.getElementById('fontScaleValue');

            // Calendario
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarMonthYear = document.getElementById('calendarMonthYear');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            
            // Panel de detalles
            const detailsDate = document.getElementById('details-date');
            const detailsHeading = document.getElementById('details-heading');
            const audioListDay = document.getElementById('audioListDay');
            const dayNotesText = document.getElementById('dayNotesText'); 
            const saveNoteBtn = document.getElementById('saveNoteBtn'); 
            const deleteNoteBtn = document.getElementById('deleteNoteBtn'); 
            const moodSelector = document.getElementById('moodSelector'); 
            const currentMoodDisplay = document.getElementById('currentMoodDisplay'); 
            // NUEVO: Summary refs
            const summaryTotalAudios = document.getElementById('summaryTotalAudios');
            const summaryTotalDuration = document.getElementById('summaryTotalDuration');
            const summaryMoodStatus = document.getElementById('summaryMoodStatus');
            
            // NUEVO: Stats refs
            const statsTotalFiles = document.getElementById('statsTotalFiles');
            const statsTotalMoodDays = document.getElementById('statsTotalMoodDays');
            const statsTotalAssignedDuration = document.getElementById('statsTotalAssignedDuration');
            const statsTotalPlaylists = document.getElementById('statsTotalPlaylists');

            // Reproductor
            const audio = document.getElementById('audioElement');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const playPauseIcon = document.getElementById('playPauseIcon');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const progressSlider = document.getElementById('progressSlider');
            const currentTimeEl = document.getElementById('currentTime');
            const totalTimeEl = document.getElementById('totalTime');
            const volumeSlider = document.getElementById('volumeSlider');
            const muteBtn = document.getElementById('muteBtn');
            const volumeIcon = document.getElementById('volumeIcon');
            const trackTitle = document.getElementById('trackTitle');
            const trackArtist = document.getElementById('trackArtist');
            const trackCover = document.getElementById('trackCover'); 
            
            // NUEVO: Edición de Playlist
            const editPlaylistModal = document.getElementById('editPlaylistModal');
            const editPlaylistNameTitle = document.getElementById('editPlaylistNameTitle');
            const playlistNameInput = document.getElementById('playlistNameInput');
            const playlistDescriptionInput = document.getElementById('playlistDescriptionInput');
            const playlistCoverPreview = document.getElementById('playlistCoverPreview');
            const coverFileInput = document.getElementById('coverFileInput');
            const playlistCoverImageContainer = document.getElementById('playlistCoverImageContainer');
            const playlistEditTrackList = document.getElementById('playlistEditTrackList');
            const savePlaylistEditBtn = document.getElementById('savePlaylistEditBtn');

            // NUEVO: Refs para el Canvas de Partículas
            const particleCanvas = document.getElementById('particleCanvas');
            const particleCtx = particleCanvas.getContext('2d');
            // MODIFICADO: Refs para el Canvas del Header
            const headerWaveCanvas = document.getElementById('headerWaveCanvas');
            const headerWaveCtx = headerWaveCanvas.getContext('2d');
            
            // NUEVO: Instancia del gráfico de ánimo
            let moodChartInstance = null; 

            // --- Estado de la Aplicación ---
            let isPlaying = false;
            let currentDate = new Date(); // Fecha para el calendario
            let selectedDateKey = null; // YYYY-MM-DD
            let selectedDayElement = null;
            let db; // Instancia de la base de datos IndexedDB
            let currentArtworkBlobUrl = null; 
            let currentPlaylistBeingEdited = null; // NUEVO: Guarda el objeto playlist que se está editando
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            // NUEVO: Estado para partículas y audio
            let particles = [];
            let audioContext, analyser, source, dataArray;
            let audioSetupDone = false;
            let particlesEnabled = true;
            let particleColor = 'rgba(224, 224, 224, 0.5)';


            // --- Configuración de IndexedDB ---
            const DB_NAME = 'mediaLibraryDB';
            const DB_VERSION = 6; 
            const STORE_AUDIO = 'audioFiles';
            const STORE_ASSIGNMENTS = 'calendarAssignments'; 
            const STORE_NOTES = 'dayNotes'; 
            const STORE_PLAYLISTS = 'playlists'; 
            const STORE_SETTINGS = 'appSettings'; 
            const STORE_MOOD = 'dayMood'; 

            /**
             * Abre la conexión con IndexedDB y crea/actualiza almacenes.
             */
            function openDb() {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error("Error al abrir IndexedDB:", event.target.error);
                    showStatusMessage("Error grave al iniciar la base de datos.", "error");
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    // Almacenes de audio, asignaciones, notas, playlists, settings y mood (existentes/actualizados)
                    if (!db.objectStoreNames.contains(STORE_AUDIO)) {
                        const audioStore = db.createObjectStore(STORE_AUDIO, { keyPath: 'id', autoIncrement: true });
                        audioStore.createIndex('title', 'title', { unique: false });
                        audioStore.createIndex('artist', 'artist', { unique: false }); 
                        audioStore.createIndex('album', 'album', { unique: false }); 
                    }
                    if (!db.objectStoreNames.contains(STORE_ASSIGNMENTS)) {
                        const assignmentStore = db.createObjectStore(STORE_ASSIGNMENTS, { autoIncrement: true });
                        assignmentStore.createIndex('date', 'date', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_NOTES)) {
                        db.createObjectStore(STORE_NOTES, { keyPath: 'date' });
                    }
                    if (!db.objectStoreNames.contains(STORE_PLAYLISTS)) {
                        const playlistStore = db.createObjectStore(STORE_PLAYLISTS, { keyPath: 'id', autoIncrement: true });
                        playlistStore.createIndex('name', 'name', { unique: false });
                    } 
                    if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                        db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                    }
                    if (!db.objectStoreNames.contains(STORE_MOOD)) {
                        db.createObjectStore(STORE_MOOD, { keyPath: 'date' });
                    }
                    
                    console.log("Almacenes de IndexedDB creados/actualizados.");
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("IndexedDB abierto correctamente.");
                    loadInitialData();
                };
            }
            
            /**
             * Carga los datos iniciales (biblioteca, playlists y calendario).
             */
            function loadInitialData() {
                renderLibraryTable();
                renderPlaylists(); 
                loadCalendar(currentDate.getMonth(), currentDate.getFullYear());
                loadAppSettings(); 
                
                // Iniciar sistema de partículas
                resizeCanvas();
                initParticles();
                animateVisuals(); 
                window.addEventListener('resize', resizeCanvas);

                // Seleccionar el día de hoy por defecto
                const todayKey = dateToKey(new Date());
                const todayEl = document.querySelector(`.calendar-day[data-date="${todayKey}"]`);
                if (todayEl) {
                    selectDay(todayEl);
                }
            }


            // --- 1. Lógica de la Interfaz (Vistas y Sidebar) ---
            
            /**
             * NUEVO: Aplica el color de acento personalizado y establece variables CSS.
             */
            function applyCustomColor(hexColor) {
                // Aplica el color como text-accent y bg-accent (para botones de play, etc.)
                document.documentElement.style.setProperty('--custom-text-accent', hexColor);
                document.documentElement.style.setProperty('--custom-bg-accent', hexColor); 
                
                // Para el hover, simplemente usamos un tono más oscuro o el color base si no es animado.
                // Aquí, para simplificar y evitar cálculos de color en JS, lo establecemos un poco más oscuro
                // o confiamos en que el CSS base sea suficiente. Usaremos un color fijo más oscuro para hover.
                // En temas light/dark, el custom color se aplicará al acento.
                // Guardamos el color en el input por si se cargó por defecto (solo necesario para inicialización)
                if (accentColorInput) accentColorInput.value = hexColor;
            }

            /**
             * NUEVO: Aplica la escala de fuente personalizada.
             */
            function applyFontScale(scalePercentage) {
                const basePx = 16 * (scalePercentage / 100);
                document.documentElement.style.setProperty('--base-font-size', `${basePx}px`);
                if (fontScaleValue) fontScaleValue.textContent = scalePercentage;
                if (fontScaleSlider) fontScaleSlider.value = scalePercentage;
            }

            /**
             * NUEVO: Aplica la clase de tema al body y define el color de la partícula.
             */
            function applyTheme(themeValue) {
                // 1. Limpiar todos los temas y custom colors
                body.classList.remove('light-theme', 'animated-theme', 'theme-ocean', 'theme-synthwave', 'theme-aurora', 'theme-fire', 'theme-galaxy');
                
                // 2. Color por defecto para partículas (blanco suave)
                particleColor = 'rgba(224, 224, 224, 0.5)';

                switch(themeValue) {
                    case 'light-theme':
                        body.classList.add('light-theme');
                        particleColor = 'rgba(82, 82, 91, 0.5)'; // Gris oscuro para temas claros
                        break;
                    case 'theme-ocean':
                        body.classList.add('animated-theme', 'theme-ocean');
                        particleColor = 'rgba(94, 243, 255, 0.7)'; // Cian brillante
                        break;
                    case 'theme-synthwave':
                        body.classList.add('animated-theme', 'theme-synthwave');
                        particleColor = 'rgba(255, 128, 215, 0.7)'; // Rosa brillante
                        break;
                    case 'theme-aurora': // NUEVO
                        body.classList.add('animated-theme', 'theme-aurora');
                        particleColor = 'rgba(0, 255, 115, 0.7)'; // Verde neón
                        break;
                    case 'theme-fire': // NUEVO
                        body.classList.add('animated-theme', 'theme-fire');
                        particleColor = 'rgba(255, 153, 0, 0.8)'; // Naranja
                        break;
                    case 'theme-galaxy': // NUEVO
                        body.classList.add('animated-theme', 'theme-galaxy');
                        particleColor = 'rgba(179, 163, 233, 0.7)'; // Púrpura claro
                        break;
                    case 'default-dark':
                    default:
                        // 'default-dark' state (no class added)
                        break;
                }
            }

            /**
             * NUEVO: Carga la configuración de la app (ej. tema, color, escala) desde DB
             */
            function loadAppSettings() {
                if (!db) return;
                const transaction = db.transaction([STORE_SETTINGS], 'readonly');
                const store = transaction.objectStore(STORE_SETTINGS);

                let fetchedTheme = 'default-dark';
                let fetchedColor = '#60a5fa'; // Default --text-accent
                let fetchedScale = 100;
                
                // 1. Fetch all settings (use Promise.all for concurrency)
                const fetchTheme = new Promise(resolve => {
                    store.get('theme').onsuccess = (e) => {
                        fetchedTheme = (e.target.result && e.target.result.value) ? e.target.result.value : 'default-dark';
                        resolve();
                    };
                });

                const fetchColor = new Promise(resolve => {
                    store.get('customAccentColor').onsuccess = (e) => {
                        fetchedColor = (e.target.result && e.target.result.value) ? e.target.result.value : '#60a5fa';
                        if (accentColorInput) accentColorInput.value = fetchedColor;
                        resolve();
                    };
                });
                
                const fetchScale = new Promise(resolve => {
                    store.get('fontScale').onsuccess = (e) => {
                        fetchedScale = (e.target.result && e.target.result.value) ? e.target.result.value : 100;
                        if (fontScaleSlider) fontScaleSlider.value = fetchedScale;
                        resolve();
                    };
                });

                const fetchParticles = new Promise(resolve => {
                    store.get('particlesEnabled').onsuccess = (e) => {
                        const setting = e.target.result;
                        particlesEnabled = (setting && setting.value === false) ? false : true;
                        if (particleToggle) particleToggle.checked = particlesEnabled;
                        if (!particlesEnabled) {
                             setTimeout(() => {
                                particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
                                headerWaveCtx.clearRect(0, 0, headerWaveCanvas.width, headerWaveCanvas.height);
                            }, 100);
                        }
                        resolve();
                    };
                });

                Promise.all([fetchTheme, fetchColor, fetchScale, fetchParticles]).then(() => {
                    // 2. Aplicar la escala primero
                    applyFontScale(fetchedScale);
                    
                    // 3. Aplicar tema y marcar radio button
                    applyTheme(fetchedTheme);
                    const currentRadio = document.querySelector(`.theme-selector input[value="${fetchedTheme}"]`);
                    if (currentRadio) currentRadio.checked = true;

                    // 4. Aplicar custom color si no es un tema animado
                    if (!body.classList.contains('animated-theme')) {
                         applyCustomColor(fetchedColor);
                    }
                });
            }

            /**
             * NUEVO: Guarda una configuración en la DB
             */
            function saveAppSetting(key, value) {
                if (!db) return;
                const transaction = db.transaction([STORE_SETTINGS], 'readwrite');
                const store = transaction.objectStore(STORE_SETTINGS);
                store.put({ key: key, value: value });
            }

            /**
             * NUEVO: Limpia toda la base de datos
             */
            function clearAllData() {
                if (!db) return;

                // Cierra la conexión actual para borrarla
                db.close();
                
                const request = indexedDB.deleteDatabase(DB_NAME);

                request.onsuccess = () => {
                    console.log("Base de datos eliminada.");
                    showStatusMessage("Biblioteca borrada. Recargando...", "success");
                    // Recargar la página para reiniciar la app
                    setTimeout(() => window.location.reload(), 1500);
                };
                request.onerror = (e) => {
                    console.error("Error al eliminar la base de datos:", e.target.error);
                    showStatusMessage("No se pudo borrar la base de datos.", "error");
                    // Intenta reabrir la DB si falla el borrado
                    openDb();
                };
                request.onblocked = () => {
                     console.warn("Borrado de DB bloqueado. Cierra otras pestañas.");
                     showStatusMessage("Por favor, cierra otras pestañas de esta app y reintenta.", "error");
                     openDb(); // Reabrir
                };
            }

            function toggleSidebar() {
                body.classList.toggle('sidebar-collapsed');
                const isExpanded = !body.classList.contains('sidebar-collapsed');
                sidebarToggleBtn.setAttribute('aria-expanded', isExpanded);
            }

            if (sidebarToggleBtn) {
                sidebarToggleBtn.addEventListener('click', toggleSidebar);
            }
            
            if (window.innerWidth <= 1024 && window.innerWidth > 640) {
                 body.classList.add('sidebar-collapsed');
                 sidebarToggleBtn.setAttribute('aria-expanded', false);
            }

            function switchView(viewId) {
                calendarView.classList.add('hidden');
                libraryView.classList.add('hidden');
                statisticsView.classList.add('hidden'); // NUEVO
                aboutView.classList.add('hidden'); // NUEVO
                settingsView.classList.add('hidden'); // EXISTENTE
                sidebarLinks.forEach(link => link.classList.remove('active'));

                const activeView = document.getElementById(viewId + 'View');
                const activeLink = document.querySelector(`.sidebar-nav-item[data-view="${viewId}"]`);
                
                if (activeView) activeView.classList.remove('hidden');
                if (activeLink) activeLink.classList.add('active');
                
                // NUEVO: Cargar estadísticas si la vista es la de estadísticas
                if (viewId === 'statistics') {
                    loadStatistics();
                }
            }

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = e.currentTarget.dataset.view;
                    switchView(viewId);
                });
            });

            // --- 2. Lógica del Calendario (Funcional) ---

            /**
             * Carga los días del mes en la rejilla del calendario.
             */
            function loadCalendar(month, year) {
                calendarGrid.innerHTML = ''; // Limpiar días anteriores
                
                // Añadir cabeceras
                const days = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
                days.forEach(day => {
                    const headerEl = document.createElement('div');
                    headerEl.className = 'calendar-day-header';
                    headerEl.setAttribute('role', 'columnheader');
                    headerEl.textContent = day;
                    calendarGrid.appendChild(headerEl);
                });

                calendarMonthYear.textContent = `${monthNames[month]} ${year}`;
                
                const todayKey = dateToKey(new Date());
                
                const firstDay = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                let dayOfWeek = firstDay.getDay(); // 0-6 (Dom-Sab)
                dayOfWeek = (dayOfWeek === 0) ? 6 : dayOfWeek - 1; // 0-6 (Lun-Dom)

                const prevMonthDays = new Date(year, month, 0).getDate();
                
                // 1. Días del mes anterior
                for (let i = 0; i < dayOfWeek; i++) {
                    const day = prevMonthDays - dayOfWeek + 1 + i;
                    calendarGrid.appendChild(createDayElement(null, day, false));
                }

                // 2. Días del mes actual
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    const dateKey = dateToKey(date);
                    const isToday = (dateKey === todayKey);
                    calendarGrid.appendChild(createDayElement(dateKey, i, true, isToday));
                }

                // 3. Días del mes siguiente
                const totalCells = 42; // 6 filas * 7 días
                const cellsFilled = dayOfWeek + daysInMonth;
                const nextMonthFill = totalCells - cellsFilled;

                for (let i = 1; i <= nextMonthFill; i++) {
                    calendarGrid.appendChild(createDayElement(null, i, false));
                }
                
                // NUEVO: Llamar a la actualización de indicadores
                updateCalendarVisuals(month, year);
            }
            
            /**
             * Helper para crear un elemento de día del calendario.
             */
            function createDayElement(dateKey, dayNumber, isCurrentMonth, isToday = false) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                
                if (!isCurrentMonth) {
                    dayEl.classList.add('is-disabled');
                } else {
                    dayEl.setAttribute('role', 'gridcell');
                    dayEl.setAttribute('tabindex', '0');
                    dayEl.dataset.date = dateKey;
                    dayEl.setAttribute('aria-label', `${dayNumber} de ${monthNames[currentDate.getMonth()]}`);
                    if (isToday) {
                        dayEl.classList.add('is-today');
                        dayEl.setAttribute('aria-label', dayEl.getAttribute('aria-label') + ' (Hoy)');
                    }
                }
                
                dayEl.innerHTML = `<div class="day-number">${dayNumber}</div>`;
                return dayEl;
            }
            
            /**
             * Convierte un objeto Date a un string YYYY-MM-DD.
             */
            function dateToKey(date) {
                return date.toISOString().split('T')[0];
            }
            
            /**
             * Formatea un string YYYY-MM-DD a un formato legible.
             */
            function formatKeyToDate(key) {
                const [year, month, day] = key.split('-');
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString('es-ES', {
                    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
                });
            }

            /**
             * Maneja el click en un día del calendario.
             */
            function handleDayClick(e) {
                const targetDay = e.target.closest('.calendar-day');
                if (targetDay && !targetDay.classList.contains('is-disabled')) {
                    selectDay(targetDay);
                }
            }
            
            /**
             * Selecciona un día, actualizando estado y UI.
             */
            function selectDay(dayElement) {
                if (selectedDayElement) {
                    selectedDayElement.classList.remove('is-selected');
                }
                
                dayElement.classList.add('is-selected');
                selectedDayElement = dayElement;
                selectedDateKey = dayElement.dataset.date;
                
                // Actualizar panel de detalles
                updateDetailsPanel(selectedDateKey);
            }
            
            /**
             * Actualiza el panel de detalles con la info del día seleccionado.
             */
            async function updateDetailsPanel(dateKey) {
                if (!dateKey) {
                    detailsHeading.textContent = "Detalles del Día";
                    detailsDate.textContent = "--";
                    audioListDay.innerHTML = '<li class="empty-list-message">Selecciona un día.</li>';
                    dayNotesText.value = '';
                    renderMoodSelector(null); // Limpiar mood
                    summaryTotalAudios.textContent = '0';
                    summaryTotalDuration.textContent = '0:00';
                    summaryMoodStatus.textContent = 'No registrado';
                    summaryMoodStatus.style.color = 'var(--text-secondary)';
                    return;
                }
                
                const formattedDate = formatKeyToDate(dateKey);
                detailsHeading.textContent = formattedDate.split(',')[0]; // "lunes"
                detailsDate.textContent = formattedDate.substring(formattedDate.indexOf(',') + 2); // "1 de..."
                
                let assignedTracks = [];
                let currentMood = null;

                // 1. Cargar Notas
                await new Promise(resolve => {
                    getNoteFromDB(dateKey, (note) => {
                        dayNotesText.value = note ? note.text : '';
                        resolve();
                    });
                });
                
                // 2. Cargar Mood
                await new Promise(resolve => {
                    getMoodFromDB(dateKey, (moodData) => {
                        currentMood = moodData ? moodData.mood : null;
                        renderMoodSelector(currentMood);
                        resolve();
                    });
                });

                // 3. Cargar Audios Asignados y renderizar lista
                await new Promise(resolve => {
                    getAssignmentsFromDB(dateKey, async (assignments) => {
                        const trackPromises = assignments.map(assign => 
                            new Promise(innerResolve => getFileFromDB(assign.audioId, innerResolve))
                        );
                        assignedTracks = (await Promise.all(trackPromises)).filter(t => t);
                        
                        audioListDay.innerHTML = ''; // Limpiar
                        assignedTracks.forEach(track => {
                            
                            let artworkHtml = '<svg class="icon"><use href="#icon-music"></use></svg>';
                            if (track.artworkBlob) {
                                const artUrl = URL.createObjectURL(track.artworkBlob);
                                artworkHtml = `<img src="${artUrl}" alt="${track.title}">`;
                            }

                            const li = document.createElement('li');
                            li.className = 'audio-item';
                            li.dataset.audioId = track.id; 
                            
                            li.innerHTML = `
                                <div class="audio-item-icon">${artworkHtml}</div>
                                <div class="audio-item-info">
                                    <div class="audio-item-title">${track.title}</div>
                                    <div class="audio-item-duration">${formatTime(track.duration)}</div>
                                </div>
                                <button class="audio-item-play" aria-label="Reproducir ${track.title}">
                                    <svg class="icon"><use href="#icon-play-circle"></use></svg>
                                </button>
                                <button class="audio-item-remove" data-audio-id="${track.id}" aria-label="Remover asignación">
                                    <svg class="icon"><use href="#icon-minus-circle"></use></svg>
                                </button>
                            `;
                            audioListDay.appendChild(li);
                        });
                        
                        if (assignedTracks.length === 0) {
                             audioListDay.innerHTML = '<li class="empty-list-message">No hay audios asignados.</li>';
                        }
                        
                        resolve();
                    });
                });
                
                // 4. Calcular y mostrar Resumen del Día (NUEVO)
                const totalDurationSeconds = assignedTracks.reduce((sum, track) => sum + (track.duration || 0), 0);
                
                summaryTotalAudios.textContent = assignedTracks.length;
                summaryTotalDuration.textContent = formatTime(totalDurationSeconds);
                summaryMoodStatus.textContent = currentMood ? getMoodEmoji(currentMood) : 'No registrado';
                summaryMoodStatus.style.color = currentMood ? 'var(--text-primary)' : 'var(--text-secondary)';
                
                // 5. Opcional: Refrescar los indicadores del calendario después de cualquier cambio
                updateCalendarVisuals(currentDate.getMonth(), currentDate.getFullYear());
            }

            /**
             * Añade indicadores visuales a los días del calendario (dot/badge).
             */
            async function updateCalendarVisuals(month, year) {
                if (!db) return;

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const container = document.getElementById('calendarGrid');

                // 1. Obtener todas las asignaciones y notas para el mes visible
                const assignments = await new Promise(resolve => {
                    const transaction = db.transaction([STORE_ASSIGNMENTS], 'readonly');
                    const store = transaction.objectStore(STORE_ASSIGNMENTS);
                    const request = store.getAll();
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => resolve([]);
                });
                
                const notes = await new Promise(resolve => {
                    const transaction = db.transaction([STORE_NOTES], 'readonly');
                    const store = transaction.objectStore(STORE_NOTES);
                    const request = store.getAll();
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => resolve([]);
                });
                
                const moods = await new Promise(resolve => {
                    const transaction = db.transaction([STORE_MOOD], 'readonly');
                    const store = transaction.objectStore(STORE_MOOD);
                    const request = store.getAll();
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => resolve([]);
                });

                // Convertir arrays a mapas para búsqueda rápida
                const hasAssignment = new Set(assignments.map(a => a.date));
                const notesMap = new Map(notes.map(n => [n.date, n]));
                const moodsMap = new Map(moods.map(m => [m.date, m]));
                
                // 2. Iterar sobre los días del DOM para aplicar indicadores
                for (let i = 1; i <= daysInMonth; i++) {
                    const dateKey = dateToKey(new Date(year, month, i));
                    const dayEl = container.querySelector(`.calendar-day[data-date="${dateKey}"]`);

                    if (dayEl) {
                        // Limpiar indicadores anteriores
                        dayEl.querySelectorAll('.indicators-container').forEach(cont => cont.remove());

                        // 3. Crear y añadir indicadores
                        let indicatorHtml = '';
                        
                        if (hasAssignment.has(dateKey)) {
                            indicatorHtml += `<span class="content-dot audio-dot" title="Audios asignados">🎧</span>`;
                        }
                        if (notesMap.has(dateKey) && notesMap.get(dateKey).text.trim().length > 0) {
                            indicatorHtml += `<span class="content-dot note-dot" title="Nota guardada">📝</span>`;
                        }
                        if (moodsMap.has(dateKey)) {
                            const moodObj = moodsMap.get(dateKey);
                            const emoji = getMoodEmoji(moodObj.mood).split(' ')[0];
                            indicatorHtml += `<span class="content-dot mood-dot" title="Estado de ánimo registrado">${emoji}</span>`;
                        }
                        
                        if (indicatorHtml) {
                            const indicatorContainer = document.createElement('div');
                            indicatorContainer.className = 'indicators-container';
                            indicatorContainer.innerHTML = indicatorHtml;
                            dayEl.appendChild(indicatorContainer);
                        }
                    }
                }
            }

            if (calendarGrid) calendarGrid.addEventListener('click', handleDayClick);
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    loadCalendar(currentDate.getMonth(), currentDate.getFullYear());
                });
            }
            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    loadCalendar(currentDate.getMonth(), currentDate.getFullYear());
                });
            }

            // --- 3. Lógica del Reproductor ---

            /**
             * Carga y reproduce una pista de audio.
             */
            function loadAndPlayTrack(src, title, artist = 'Desconocido', artUrl = null) {
                if (audio.src && audio.src.startsWith('blob:')) {
                    URL.revokeObjectURL(audio.src);
                }
                if (currentArtworkBlobUrl) {
                    URL.revokeObjectURL(currentArtworkBlobUrl);
                    currentArtworkBlobUrl = null;
                }
                
                audio.src = src;
                trackTitle.textContent = title;
                trackArtist.textContent = artist;
                
                if (artUrl) {
                    trackCover.innerHTML = `<img src="${artUrl}" alt="${title}">`;
                    currentArtworkBlobUrl = artUrl; 
                } else {
                    trackCover.innerHTML = '<svg class="icon"><use href="#icon-music"></use></svg>';
                }
                
                audio.play().catch(e => {
                    console.error("Error al reproducir audio:", e);
                    showStatusMessage("Error al reproducir: " + e.message, "error");
                    isPlaying = false;
                });
                
                isPlaying = true;
                playPauseIcon.setAttribute('href', '#icon-pause');
                playPauseBtn.setAttribute('aria-label', 'Pausar');
            }

            function togglePlayPause() {
                if (!audio.src) return;
                if (isPlaying) {
                    audio.pause();
                } else {
                    audio.play().catch(e => {
                        console.error("Error al reanudar audio:", e);
                        showStatusMessage("Error al reproducir: " + e.message, "error");
                        isPlaying = false;
                        return;
                    });
                }
                isPlaying = !isPlaying;
                playPauseIcon.setAttribute('href', isPlaying ? '#icon-pause' : '#icon-play');
                playPauseBtn.setAttribute('aria-label', isPlaying ? 'Pausar' : 'Reproducir');
            }
            
            function updateProgress() {
                if (audio.duration) {
                    const progressPercent = (audio.currentTime / audio.duration) * 100;
                    progressSlider.value = progressPercent;
                    currentTimeEl.textContent = formatTime(audio.currentTime);
                    if (isFinite(audio.duration)) {
                        totalTimeEl.textContent = formatTime(audio.duration);
                    }
                }
            }

            function seek() {
                if (!audio.duration) return;
                audio.currentTime = (progressSlider.value / 100) * audio.duration;
            }
            
            function setVolume() {
                audio.volume = volumeSlider.value;
                audio.muted = volumeSlider.value == 0;
                volumeIcon.setAttribute('href', audio.muted ? '#icon-volume-x' : '#icon-volume-2');
            }

            function toggleMute() {
                audio.muted = !audio.muted;
                volumeSlider.value = audio.muted ? 0 : audio.volume;
                volumeIcon.setAttribute('href', audio.muted ? '#icon-volume-x' : '#icon-volume-2');
                muteBtn.setAttribute('aria-label', audio.muted ? 'Activar sonido' : 'Silenciar');
            }
            
            function formatTime(seconds) {
                if (!isFinite(seconds)) return '--:--';
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }

            // Event Listeners del Reproductor
            if (playPauseBtn) playPauseBtn.addEventListener('click', togglePlayPause);
            if (audio) {
                audio.addEventListener('timeupdate', updateProgress);
                audio.addEventListener('loadedmetadata', updateProgress); 
                audio.addEventListener('play', () => {
                    isPlaying = true;
                    playPauseIcon.setAttribute('href', '#icon-pause');
                    playPauseBtn.setAttribute('aria-label', 'Pausar');
                });
                audio.addEventListener('pause', () => {
                    isPlaying = false;
                    playPauseIcon.setAttribute('href', '#icon-play');
                    playPauseBtn.setAttribute('aria-label', 'Reproducir');
                });
                audio.addEventListener('ended', () => { 
                    /* TODO: Pasar a la siguiente canción */ 
                });
            }
            if (progressSlider) progressSlider.addEventListener('input', seek);
            if (volumeSlider) volumeSlider.addEventListener('input', setVolume);
            if (muteBtn) muteBtn.addEventListener('click', toggleMute);
            
            // Event listener para reproducir/remover desde la lista de detalles (ACTUALIZADO)
            if (audioListDay) {
                audioListDay.addEventListener('click', (e) => {
                    const playButton = e.target.closest('.audio-item-play');
                    const removeButton = e.target.closest('.audio-item-remove'); 
                    const audioItem = e.target.closest('.audio-item');
                    if (!audioItem) return;

                    const audioId = parseInt(audioItem.dataset.audioId);
                    
                    if (playButton) {
                        if (audioId) {
                            getFileFromDB(audioId, (file) => {
                                if (file && file.blob) {
                                    const audioUrl = URL.createObjectURL(file.blob);
                                    let artUrl = file.artworkBlob ? URL.createObjectURL(file.artworkBlob) : null;
                                    loadAndPlayTrack(audioUrl, file.title, file.artist || 'Asignado', artUrl);
                                } else {
                                    showStatusMessage("No se pudo encontrar el audio.", "error");
                                    updateDetailsPanel(selectedDateKey); 
                                }
                            });
                        }
                    } else if (removeButton) { // Lógica de remover
                        if (audioId && selectedDateKey) {
                            deleteAssignmentFromDB(audioId, selectedDateKey, () => {
                                updateDetailsPanel(selectedDateKey); // Refrescar lista
                            });
                        }
                    }
                });
            }

            // --- 4. Lógica de Búsqueda (Funcional) ---
            
            function search() {
                const query = searchInput.value.toLowerCase();
                const rows = libraryTbody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const titleCell = row.cells[1] ? row.cells[1].textContent.toLowerCase() : '';
                    const artistCell = row.cells[2] ? row.cells[2].textContent.toLowerCase() : '';
                    const isMatch = titleCell.includes(query) || artistCell.includes(query);
                    row.style.display = isMatch ? '' : 'none';
                });
            }
            
            if (searchInput) searchInput.addEventListener('input', search);

            // --- 5. Lógica de Configuración (NUEVO) ---
            
            // Reemplazamos el listener del toggle por el del grupo de radio
            if (themeSelector) {
                themeRadioButtons.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const newTheme = e.target.value;
                        applyTheme(newTheme);
                        saveAppSetting('theme', newTheme);
                        // Cuando se cambia el tema, re-aplicar color custom si no es animado.
                        if (!document.body.classList.contains('animated-theme')) {
                            applyCustomColor(accentColorInput.value);
                        } else {
                            // Limpiar custom colors si se elige un tema animado
                            document.documentElement.style.removeProperty('--custom-text-accent');
                            document.documentElement.style.removeProperty('--custom-bg-accent');
                        }
                        
                    });
                });
            }
            
            // NUEVO: Listeners para personalización
            if (accentColorInput) {
                accentColorInput.addEventListener('input', (e) => {
                    // Aplica el color inmediatamente solo si no es un tema animado
                    if (!document.body.classList.contains('animated-theme')) {
                        applyCustomColor(e.target.value);
                    }
                });
                accentColorInput.addEventListener('change', (e) => {
                    // Guarda el color en la DB
                    saveAppSetting('customAccentColor', e.target.value);
                    showStatusMessage("Color de acento guardado.", "success");
                });
            }
            
            if (fontScaleSlider) {
                fontScaleSlider.addEventListener('input', (e) => {
                    // Aplica la escala inmediatamente para la vista previa
                    applyFontScale(parseInt(e.target.value));
                });
                fontScaleSlider.addEventListener('change', (e) => {
                    // Guarda la escala en la DB al soltar
                    saveAppSetting('fontScale', parseInt(e.target.value));
                    showStatusMessage("Escala de fuente guardada.", "success");
                });
            }

            // NUEVO: Listener para el interruptor de partículas
            if (particleToggle) {
                particleToggle.addEventListener('change', () => {
                    particlesEnabled = particleToggle.checked;
                    saveAppSetting('particlesEnabled', particlesEnabled);
                    if (!particlesEnabled) {
                        // Limpiar ambos canvas si se desactiva
                        particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
                        // MODIFICADO: Limpiar el canvas del header
                        headerWaveCtx.clearRect(0, 0, headerWaveCanvas.width, headerWaveCanvas.height);
                    }
                });
            }

            if (clearLibraryBtn) {
                clearLibraryBtn.addEventListener('click', () => {
                    showModal('clearLibraryConfirmModal');
                });
            }

            if (confirmClearLibraryBtn) {
                confirmClearLibraryBtn.addEventListener('click', () => {
                    hideModal('clearLibraryConfirmModal');
                    clearAllData();
                });
            }
            
            /**
             * NUEVO: Carga y renderiza los datos de estadísticas
             */
            async function loadStatistics() {
                if (!db) return;

                // 1. Total Files
                const totalFiles = await new Promise(resolve => {
                    const tx = db.transaction([STORE_AUDIO], 'readonly');
                    const request = tx.objectStore(STORE_AUDIO).count();
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => resolve(0);
                });
                statsTotalFiles.textContent = totalFiles;

                // 2. Total Mood Days
                const totalMoodDays = await new Promise(resolve => {
                    const tx = db.transaction([STORE_MOOD], 'readonly');
                    const request = tx.objectStore(STORE_MOOD).count();
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => resolve(0);
                });
                statsTotalMoodDays.textContent = totalMoodDays;
                
                // 3. Total Playlists
                const totalPlaylists = await new Promise(resolve => {
                    const tx = db.transaction([STORE_PLAYLISTS], 'readonly');
                    const request = tx.objectStore(STORE_PLAYLISTS).count();
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => resolve(0);
                });
                statsTotalPlaylists.textContent = totalPlaylists;
                
                // 4. Duración Total Asignada y archivos totales (requiere más procesamiento)
                const allAssignments = await new Promise(resolve => {
                    const tx = db.transaction([STORE_ASSIGNMENTS], 'readonly');
                    const request = tx.objectStore(STORE_ASSIGNMENTS).getAll();
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = () => resolve([]);
                });
                
                const assignedAudioIds = [...new Set(allAssignments.map(a => a.audioId))];
                let totalDurationSeconds = 0;
                
                // Obtener las duraciones de todos los audios asignados
                const durationPromises = assignedAudioIds.map(id => 
                    new Promise(resolve => getFileFromDB(id, file => resolve(file ? file.duration : 0)))
                );
                
                const durations = await Promise.all(durationPromises);
                totalDurationSeconds = durations.reduce((sum, duration) => sum + duration, 0);
                
                statsTotalAssignedDuration.textContent = formatTime(totalDurationSeconds);
                
                // 5. Renderizar Gráfico de Ánimo (Simulado por ahora)
                const simulatedMoodData = {
                    '😍 Excelente': 15,
                    '😊 Bien': 30,
                    '😐 Neutral': 25,
                    '😔 Mal': 8,
                    '😭 Pésimo': 2
                };
                renderMoodChart(simulatedMoodData);
            }
            
            /**
             * NUEVO: Renderiza el gráfico de distribución de estado de ánimo.
             */
            function renderMoodChart(data) {
                const ctx = document.getElementById('moodChartCanvas');
                
                // Si ya existe, destruirlo antes de crear uno nuevo
                if (moodChartInstance) {
                    moodChartInstance.destroy();
                }
                
                const moods = Object.keys(data);
                const counts = Object.values(data);

                // Definir colores específicos para cada estado de ánimo (coinciden con los de la app)
                const moodColors = [
                    '#4ade80', // Excelente (Verde)
                    '#60a5fa', // Bien (Azul claro, var(--text-accent))
                    '#d4d4d8', // Neutral (Gris claro)
                    '#a78bfa', // Mal (Morado, var(--bg-accent))
                    '#ef4444'  // Pésimo (Rojo)
                ];
                
                // Obtener los colores correspondientes a las etiquetas presentes
                const backgroundColors = moods.map((mood, index) => {
                    const emoji = mood.split(' ')[0];
                    if (emoji === '😍') return moodColors[0];
                    if (emoji === '😊') return moodColors[1];
                    if (emoji === '😐') return moodColors[2];
                    if (emoji === '😔') return moodColors[3];
                    if (emoji === '😭') return moodColors[4];
                    return '#3a3a3a'; // Fallback
                });
                

                moodChartInstance = new Chart(ctx, {
                    type: 'bar', // Tipo: 'bar' (barras) o 'doughnut' (pastel)
                    data: {
                        labels: moods,
                        datasets: [{
                            label: 'Conteo de Días',
                            data: counts,
                            backgroundColor: backgroundColors,
                            // Los bordes son un poco más oscuros que el fondo
                            borderColor: backgroundColors.map(c => c.replace('0.6', '1')), 
                            borderWidth: 1,
                            borderRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Ocultar leyenda (las etiquetas están en el eje X)
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            // Formato: 30 días
                                            label += new Intl.NumberFormat('es-ES').format(context.parsed.y) + ' días'; 
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text-secondary)',
                                    precision: 0 // Solo números enteros
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--text-primary)'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }


            // --- 6. Lógica de Biblioteca y Carga de Archivos --- (Renumerado)
            
            function handleFiles(files) {
                const allowedTypes = ['audio/'];
                let addedCount = 0;

                Array.from(files).forEach(file => {
                    if (allowedTypes.some(type => file.type.startsWith(type))) {
                        processFile(file);
                        addedCount++;
                    } else {
                        showStatusMessage(`Archivo no permitido: ${file.name} (${file.type})`, "error");
                    }
                });
                
                if (addedCount > 0) {
                    showStatusMessage(`${addedCount} archivo(s) añadido(s) a la cola de procesamiento.`, "success");
                }
            }
            
            async function processFile(file) {
                try {
                    const metadata = await musicMetadata.parseBlob(file);
                    const title = metadata.common.title || file.name;
                    const artist = metadata.common.artist || 'Desconocido';
                    const album = metadata.common.album || 'Desconocido';
                    const duration = metadata.format.duration || 0;
                    
                    let artworkBlob = null;
                    const picture = metadata.common.picture ? metadata.common.picture[0] : null;
                    if (picture) {
                        artworkBlob = new Blob([picture.data], { type: picture.format });
                    }

                    const fileData = { title, artist, album, size: file.size, type: file.type, duration, artworkBlob, blob: file };
                    
                    addFileToDB(STORE_AUDIO, fileData, () => {
                         showStatusMessage(`'${fileData.title}' añadido a la biblioteca.`, "success");
                         renderLibraryTable(); 
                    });

                } catch (error) {
                    console.warn(`No se pudieron leer metadatos de ${file.name}: ${error.message}. Usando fallback.`);
                    try {
                        const duration = await getAudioDuration_fallback(file);
                        const fileData = {
                            title: file.name, artist: 'Desconocido', album: 'Desconocido',
                            size: file.size, type: file.type, duration: duration,
                            artworkBlob: null, blob: file
                        };
                        addFileToDB(STORE_AUDIO, fileData, () => {
                             showStatusMessage(`'${fileData.title}' añadido (fallback).`, "success");
                             renderLibraryTable();
                        });
                    } catch (err2) {
                        console.error("Error al procesar archivo (fallback):", file.name, err2);
                        showStatusMessage(`Error al procesar: ${file.name}`, "error");
                    }
                }
            }
            
            function getAudioDuration_fallback(file) {
                return new Promise((resolve, reject) => {
                    const audioEl = document.createElement('audio');
                    audioEl.preload = 'metadata';
                    audioEl.src = URL.createObjectURL(file);
                    audioEl.onloadedmetadata = () => { URL.revokeObjectURL(audioEl.src); resolve(audioEl.duration); };
                    audioEl.onerror = (e) => { URL.revokeObjectURL(audioEl.src); reject(new Error("No se pudo cargar el metadata.")); };
                });
            }

            if (fileInput) fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
                dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
            }

            // --- 6. Lógica de IndexedDB (CRUD Genérica y Específica) ---

            /**
             * Añade datos a un almacén.
             */
            function addFileToDB(storeName, data, onSuccess) {
                if (!db) return;
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                if (onSuccess) request.onsuccess = onSuccess;
                request.onerror = (e) => console.error(`Error al añadir a ${storeName}:`, e.target.error);
            }
            
            /**
             * Añade o actualiza datos en un almacén (Put).
             */
            function putDataInDB(storeName, data, onSuccess) {
                 if (!db) return;
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                if (onSuccess) request.onsuccess = onSuccess;
                request.onerror = (e) => console.error(`Error al actualizar (put) en ${storeName}:`, e.target.error);
            }

            /**
             * Renderiza la tabla de la biblioteca desde IndexedDB.
             */
            function renderLibraryTable() {
                if (!db) return; 
                
                const transaction = db.transaction([STORE_AUDIO], 'readonly');
                const store = transaction.objectStore(STORE_AUDIO);
                const request = store.getAll();
                
                request.onsuccess = (e) => {
                    const files = e.target.result;
                    libraryTbody.innerHTML = ''; 
                    
                    if (!files || files.length === 0) {
                        libraryTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Tu biblioteca está vacía. Añade archivos.</td></tr>';
                        return;
                    }
                    
                    files.forEach(file => {
                        const tr = document.createElement('tr');
                        
                        let artworkHtml = '<svg class="icon"><use href="#icon-music"></use></svg>';
                        if (file.artworkBlob) {
                            const artUrl = URL.createObjectURL(file.artworkBlob);
                            // TODO: Gestionar revocación de estas URLs al eliminar la fila
                            artworkHtml = `<img src="${artUrl}" alt="Cover">`;
                        }
                        
                        tr.innerHTML = `
                            <td class="artwork-cell">${artworkHtml}</td>
                            <td class="track-title-cell">
                                <button class="btn-lib play-lib-btn" data-id="${file.id}" aria-label="Reproducir ${file.title}">
                                    <svg class="icon"><use href="#icon-play-circle"></use></svg>
                                </button>
                                ${file.title}
                            </td>
                            <td>${file.artist || 'Desconocido'}</td>
                            <td>${formatTime(file.duration)}</td>
                            <td>${formatBytes(file.size)}</td>
                            <td>${file.type}</td>
                            <td class="action-buttons">
                                <button class="btn-lib playlist-btn" data-id="${file.id}" aria-label="Añadir a playlist">
                                    <svg class="icon icon-playlist"><use href="#icon-playlist"></use></svg>
                                </button>
                                <button class="btn-lib assign-btn" data-id="${file.id}" aria-label="Asignar al día">
                                    <svg class="icon"><use href="#icon-calendar"></use></svg>
                                </button>
                                <button class="btn-lib metadata-btn" data-id="${file.id}" aria-label="Ver metadatos">
                                    <svg class="icon"><use href="#icon-info"></use></svg>
                                </button>
                                <button class="btn-lib delete-btn" data-id="${file.id}" data-name="${file.title}" aria-label="Eliminar">
                                    <svg class="icon icon-delete"><use href="#icon-trash"></use></svg>
                                </button>
                            </td>
                        `;
                        libraryTbody.appendChild(tr);
                    });
                };
                
                request.onerror = (e) => console.error("Error al leer de DB:", e.target.error);
            }
            
            /**
             * Elimina un archivo de IndexedDB por ID y limpia referencias.
             */
            function deleteFileFromDB(id) {
                const transaction = db.transaction([STORE_AUDIO], 'readwrite');
                const store = transaction.objectStore(STORE_AUDIO);
                const request = store.delete(id);
                
                request.onsuccess = () => {
                    console.log("Archivo eliminado, ID:", id);
                    showStatusMessage("Archivo eliminado de la biblioteca.", "success");
                    renderLibraryTable(); // Recargar
                    // Limpiar referencias en otras tablas
                    deleteAudioIdFromAssignments(id);
                    deleteAudioIdFromPlaylists(id);
                };
                request.onerror = (e) => console.error("Error al eliminar de DB:", e.target.error);
            }
            
            /**
             * Obtiene un archivo de IndexedDB por ID.
             */
            function getFileFromDB(id, callback) {
                const transaction = db.transaction([STORE_AUDIO], 'readonly');
                const store = transaction.objectStore(STORE_AUDIO);
                const request = store.get(id);
                request.onsuccess = (e) => callback(e.target.result);
                request.onerror = (e) => console.error("Error al obtener archivo:", e.target.error);
            }
            
            // --- Funciones específicas de Asignaciones, Notas y Playlists ---
            
            function getAssignmentsFromDB(dateKey, callback) {
                const transaction = db.transaction([STORE_ASSIGNMENTS], 'readonly');
                const store = transaction.objectStore(STORE_ASSIGNMENTS);
                const index = store.index('date');
                const request = index.getAll(dateKey); // Busca todos los que coincidan con la fecha
                request.onsuccess = (e) => callback(e.target.result);
                request.onerror = (e) => console.error("Error al obtener asignaciones:", e.target.error);
            }
            
            /**
             * Función para eliminar una asignación específica por audioId y dateKey. (Nuevo)
             */
            function deleteAssignmentFromDB(audioId, dateKey, callback) {
                const transaction = db.transaction([STORE_ASSIGNMENTS], 'readwrite');
                const store = transaction.objectStore(STORE_ASSIGNMENTS);
                const index = store.index('date');
                const keyRange = IDBKeyRange.only(dateKey);
                const request = index.openCursor(keyRange);

                request.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        if (cursor.value.audioId === audioId) {
                            cursor.delete();
                            showStatusMessage(`Audio removido del día ${dateKey}.`, "success");
                            if (callback) callback();
                            return;
                        }
                        cursor.continue();
                    }
                };
                request.onerror = (e) => console.error("Error al borrar asignación:", e.target.error);
            }
            
            function getNoteFromDB(dateKey, callback) {
                const transaction = db.transaction([STORE_NOTES], 'readonly');
                const store = transaction.objectStore(STORE_NOTES);
                const request = store.get(dateKey); // Busca por clave principal
                request.onsuccess = (e) => callback(e.target.result);
                request.onerror = (e) => console.error("Error al obtener nota:", e.target.error);
            }
            
            /**
             * Función para eliminar una nota del día. (Nuevo)
             */
            function deleteNoteFromDB(dateKey, callback) {
                if (!db) return;
                const transaction = db.transaction([STORE_NOTES], 'readwrite');
                const store = transaction.objectStore(STORE_NOTES);
                const request = store.delete(dateKey);
                request.onsuccess = () => {
                    showStatusMessage(`Nota borrada para ${dateKey}`, "success");
                    if (callback) callback();
                };
                request.onerror = (e) => console.error("Error al borrar nota:", e.target.error);
            }
            
            /**
             * Carga el estado de ánimo de la DB para un día. (Nuevo)
             */
            function getMoodFromDB(dateKey, callback) {
                if (!db) return;
                const transaction = db.transaction([STORE_MOOD], 'readonly');
                const store = transaction.objectStore(STORE_MOOD);
                const request = store.get(dateKey);
                request.onsuccess = (e) => callback(e.target.result);
                request.onerror = (e) => console.error("Error al obtener ánimo:", e.target.error);
            }
            
            /**
             * Guarda el estado de ánimo para un día. (Nuevo)
             */
            function saveMoodToDB(dateKey, moodValue, callback) {
                if (!db) return;
                const transaction = db.transaction([STORE_MOOD], 'readwrite');
                const store = transaction.objectStore(STORE_MOOD);
                const moodData = { date: dateKey, mood: moodValue };
                const request = store.put(moodData);
                request.onsuccess = () => {
                    showStatusMessage(`Estado de ánimo guardado (${getMoodEmoji(moodValue).split(' ')[0]})`, "success");
                    if (callback) callback();
                };
                request.onerror = (e) => console.error("Error al guardar ánimo:", e.target.error);
            }

            /**
             * Renderiza el selector de estado de ánimo y aplica el estado actual. (Nuevo)
             */
            function renderMoodSelector(currentMood) {
                currentMoodDisplay.textContent = currentMood ? `Actual: ${getMoodEmoji(currentMood)}` : 'No registrado';
                const moodButtons = moodSelector.querySelectorAll('button');
                moodButtons.forEach(btn => {
                    btn.classList.remove('selected');
                    const moodValue = parseInt(btn.dataset.mood);
                    if (moodValue === currentMood) {
                        btn.classList.add('selected');
                    }
                });
            }

            /**
             * Retorna el emoji basado en el valor. (Nuevo)
             */
            function getMoodEmoji(moodValue) {
                switch(moodValue) {
                    case 5: return '😍 Excelente';
                    case 4: return '😊 Bien';
                    case 3: return '😐 Neutral';
                    case 2: return '😔 Mal';
                    case 1: return '😭 Pésimo';
                    default: return 'No registrado';
                }
            }

            /**
             * Carga y muestra la lista de playlists en la sidebar. (MODIFICADO)
             */
            function renderPlaylists() {
                if (!db) return; 

                const transaction = db.transaction([STORE_PLAYLISTS], 'readonly');
                const store = transaction.objectStore(STORE_PLAYLISTS);
                const request = store.getAll();

                request.onerror = (e) => console.error("Error al cargar playlists:", e.target.error);
                
                request.onsuccess = (e) => {
                    const playlists = e.target.result;
                    playlistList.innerHTML = ''; // Limpiar lista

                    if (!playlists || playlists.length === 0) {
                        playlistList.innerHTML = '<li><a href="#" class="sidebar-nav-item" style="color: var(--text-secondary); opacity: 0.7;"><span class="sidebar-nav-text" style="padding-left: 24px;">No hay playlists. Créa una.</span></a></li>';
                        return;
                    }

                    playlists.forEach(playlist => {
                        const li = document.createElement('li');
                        li.className = 'playlist-sidebar-item';
                        
                        let artworkHtml = `<svg class="icon"><use href="#icon-playlist"></use></svg>`;
                        // TODO: Mostrar cover si existe (implementación más compleja para la sidebar)

                        li.innerHTML = `
                            <a href="#" class="sidebar-nav-item" data-playlist-id="${playlist.id}" data-view="playlist-detail">
                                ${artworkHtml}
                                <span class="sidebar-nav-text">${playlist.name}</span>
                            </a>
                            <button class="edit-playlist-btn" data-playlist-id="${playlist.id}" aria-label="Editar playlist">
                                <svg class="icon icon-edit"><use href="#icon-edit-2"></use></svg>
                            </button>
                        `;
                        playlistList.appendChild(li);
                    });
                };
            }
            
            /**
             * Elimina un audioId de todas las asignaciones del calendario. (Nueva)
             */
            function deleteAudioIdFromAssignments(audioId) {
                const transaction = db.transaction([STORE_ASSIGNMENTS], 'readwrite');
                const store = transaction.objectStore(STORE_ASSIGNMENTS);
                const request = store.openCursor();

                request.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        if (cursor.value.audioId === audioId) {
                            cursor.delete();
                        }
                        cursor.continue();
                    } else {
                        console.log(`Audio ${audioId} eliminado de asignaciones.`);
                        if (selectedDateKey) updateDetailsPanel(selectedDateKey); // Refrescar panel
                    }
                };
                request.onerror = (e) => console.error("Error limpiando asignaciones:", e.target.error);
            }
            
            /**
             * Elimina un audioId de todas las playlists. (Nueva)
             */
            function deleteAudioIdFromPlaylists(audioId) {
                const transaction = db.transaction([STORE_PLAYLISTS], 'readwrite');
                const store = transaction.objectStore(STORE_PLAYLISTS);
                const request = store.openCursor();
                
                request.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        const playlist = cursor.value;
                        const trackIndex = playlist.tracks.indexOf(audioId);
                        if (trackIndex > -1) {
                            playlist.tracks.splice(trackIndex, 1);
                            cursor.update(playlist);
                        }
                        cursor.continue();
                    } else {
                        console.log(`Audio ${audioId} eliminado de playlists.`);
                    }
                };
                request.onerror = (e) => console.error("Error limpiando playlists:", e.target.error);
            }

            // Manejador de acciones de la tabla de biblioteca
            if (libraryTbody) {
                libraryTbody.addEventListener('click', (e) => {
                    const button = e.target.closest('.btn-lib');
                    if (!button) return;
                    
                    const id = parseInt(button.dataset.id);
                    
                    if (button.classList.contains('play-lib-btn')) {
                        getFileFromDB(id, (file) => {
                            if (file && file.blob) {
                                const blobUrl = URL.createObjectURL(file.blob);
                                let artUrl = file.artworkBlob ? URL.createObjectURL(file.artworkBlob) : null;
                                loadAndPlayTrack(blobUrl, file.title, file.artist || 'Biblioteca', artUrl);
                            } else {
                                showStatusMessage("No se pudo encontrar el archivo.", "error");
                            }
                        });
                    } else if (button.classList.contains('delete-btn')) {
                        trackToDeleteName.textContent = button.dataset.name;
                        deleteConfirmModal.dataset.idToDelete = id;
                        showModal('deleteConfirmModal');
                    } else if (button.classList.contains('assign-btn')) {
                        if (selectedDateKey) {
                            audioToAssignId.textContent = id;
                            assignModalDate.textContent = formatKeyToDate(selectedDateKey);
                            showModal('assignDayModal');
                        } else {
                            showStatusMessage("Por favor, selecciona un día en el calendario primero.", "error");
                        }
                    } else if (button.classList.contains('metadata-btn')) {
                        getFileFromDB(id, (file) => {
                            if (file) {
                                metadataModalBody.innerHTML = `
                                    <p><strong>Título:</strong> ${file.title}</p>
                                    <p><strong>Artista:</strong> ${file.artist}</p>
                                    <p><strong>Álbum:</strong> ${file.album}</p>
                                    <p><strong>Tamaño:</strong> ${formatBytes(file.size)}</p>
                                    <p><strong>Tipo:</strong> ${file.type}</p>
                                    <p><strong>Duración:</strong> ${formatTime(file.duration)}</p>
                                    <p><strong>ID Interno:</strong> ${file.id}</p>
                                `;
                                showModal('metadataModal');
                            }
                        });
                    } else if (button.classList.contains('playlist-btn')) {
                        audioToPlaylistId.textContent = id;
                        loadPlaylistsIntoModal(id); // Cargar playlists en el modal
                        showModal('addPlaylistModal');
                    }
                });
            }


            // --- 7. Lógica de Modales y Notificaciones ---
            
            let statusTimer;
            function showStatusMessage(message, type = 'success') {
                statusMessageText.textContent = message;
                statusMessage.className = `status-message ${type}`;
                statusMessage.classList.add('show');
                
                clearTimeout(statusTimer);
                statusTimer = setTimeout(() => {
                    statusMessage.classList.remove('show');
                }, 3000);
            }

            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.remove('hidden');
            }

            function hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.add('hidden');
            }
            
            modalCloseBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modalId = e.currentTarget.dataset.modalId;
                    hideModal(modalId);
                });
            });
            
            // Lógica del botón "Asignar"
            const saveAssignmentBtn = document.getElementById('saveAssignmentBtn');
            if(saveAssignmentBtn) {
                saveAssignmentBtn.addEventListener('click', () => {
                    const audioId = parseInt(audioToAssignId.textContent);
                    if (selectedDateKey && audioId) {
                        const assignmentData = { date: selectedDateKey, audioId: audioId };
                        addFileToDB(STORE_ASSIGNMENTS, assignmentData, () => {
                            showStatusMessage(`Audio asignado a ${selectedDateKey}`, "success");
                            hideModal('assignDayModal');
                            updateDetailsPanel(selectedDateKey); // Recargar panel
                        });
                    } else {
                        showStatusMessage("Error al asignar. Selecciona un día.", "error");
                    }
                });
            }
            
            // Lógica del botón "Guardar Nota" (ACTUALIZADO)
            if (saveNoteBtn) {
                saveNoteBtn.addEventListener('click', () => {
                    if (selectedDateKey) {
                        const noteData = { date: selectedDateKey, text: dayNotesText.value };
                        putDataInDB(STORE_NOTES, noteData, () => {
                            showStatusMessage(`Nota guardada para ${selectedDateKey}`, "success");
                            updateCalendarVisuals(currentDate.getMonth(), currentDate.getFullYear());
                        });
                    } else {
                        showStatusMessage("Selecciona un día para guardar la nota.", "error");
                    }
                });
            }
            
            // Lógica del botón "Borrar Nota" (NUEVO)
            if (deleteNoteBtn) {
                deleteNoteBtn.addEventListener('click', () => {
                    if (selectedDateKey) {
                        deleteNoteFromDB(selectedDateKey, () => {
                            dayNotesText.value = ''; // Limpiar UI
                            updateDetailsPanel(selectedDateKey); // Refrescar panel y resumen
                        });
                    } else {
                        showStatusMessage("Selecciona un día para borrar la nota.", "error");
                    }
                });
            }

            // Listener para el Mood Selector (NUEVO)
            if (moodSelector) {
                moodSelector.addEventListener('click', (e) => {
                    const moodButton = e.target.closest('button[data-mood]');
                    if (!moodButton || !selectedDateKey) return;
                    
                    const newMood = parseInt(moodButton.dataset.mood);
                    saveMoodToDB(selectedDateKey, newMood, () => {
                        renderMoodSelector(newMood);
                        updateCalendarVisuals(currentDate.getMonth(), currentDate.getFullYear());
                    });
                });
            }
            
            // Lógica del modal de confirmación de borrado
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', () => {
                    const id = parseInt(deleteConfirmModal.dataset.idToDelete);
                    if (id) {
                        deleteFileFromDB(id);
                    }
                    hideModal('deleteConfirmModal');
                });
            }
            
            // Lógica de crear nueva playlist (Nuevo)
            if (newPlaylistBtn) {
                newPlaylistBtn.addEventListener('click', () => {
                    newPlaylistNameInput.value = '';
                    showModal('createPlaylistModal');
                });
            }

            if (saveNewPlaylistBtn) {
                saveNewPlaylistBtn.addEventListener('click', () => {
                    const playlistName = newPlaylistNameInput.value.trim();
                    if (playlistName) {
                        const playlistData = {
                            name: playlistName,
                            description: '', // Nuevo campo
                            artworkBlob: null, // Nuevo campo
                            tracks: [] // array of audioId
                        };
                        
                        addFileToDB(STORE_PLAYLISTS, playlistData, () => {
                            showStatusMessage(`Playlist '${playlistName}' creada.`, 'success');
                            hideModal('createPlaylistModal');
                            renderPlaylists(); // Actualizar la lista en la sidebar
                        });
                    } else {
                        showStatusMessage("Introduce un nombre para la playlist.", "error");
                    }
                });
            }
            
            /**
             * Carga la lista de playlists en el modal "Añadir a Playlist" (Nueva)
             */
            function loadPlaylistsIntoModal(audioId) {
                if (!db) return;
                
                const transaction = db.transaction([STORE_PLAYLISTS], 'readonly');
                const store = transaction.objectStore(STORE_PLAYLISTS);
                const request = store.getAll();
                
                request.onerror = (e) => console.error("Error cargando playlists para modal:", e.target.error);
                
                request.onsuccess = (e) => {
                    const playlists = e.target.result;
                    modalPlaylistList.innerHTML = '';
                    
                    if (!playlists || playlists.length === 0) {
                        modalPlaylistList.innerHTML = '<li style="padding: 12px 20px;">No hay playlists. Créa una primero.</li>';
                        return;
                    }
                    
                    playlists.forEach(playlist => {
                        const li = document.createElement('li');
                        const isTrackInPlaylist = playlist.tracks.includes(audioId);
                        
                        li.innerHTML = `
                            <button class="sidebar-nav-item" data-playlist-id="${playlist.id}" ${isTrackInPlaylist ? 'disabled' : ''} style="width: 100%; text-align: left; ${isTrackInPlaylist ? 'background-color: var(--bg-main);' : ''}">
                                <svg class="icon"><use href="#icon-playlist"></use></svg>
                                <span class="sidebar-nav-text">${playlist.name} ${isTrackInPlaylist ? '(Añadido)' : ''}</span>
                            </button>
                        `;
                        if (!isTrackInPlaylist) {
                            li.querySelector('button').addEventListener('click', () => {
                                addTrackToPlaylist(audioId, playlist.id);
                            });
                        }
                        modalPlaylistList.appendChild(li);
                    });
                };
            }
            
            /**
             * Añade un ID de audio a una playlist en la DB. (Nueva)
             */
            function addTrackToPlaylist(audioId, playlistId) {
                const transaction = db.transaction([STORE_PLAYLISTS], 'readwrite');
                const store = transaction.objectStore(STORE_PLAYLISTS);
                const request = store.get(playlistId);
                
                request.onerror = (e) => console.error("Error al obtener playlist:", e.target.error);
                
                request.onsuccess = (e) => {
                    const playlist = e.target.result;
                    if (playlist) {
                        if (!playlist.tracks.includes(audioId)) {
                            playlist.tracks.push(audioId);
                            store.put(playlist).onsuccess = () => {
                                showStatusMessage(`Audio añadido a '${playlist.name}'`, 'success');
                                hideModal('addPlaylistModal');
                            };
                        } else {
                            // Esto no debería pasar si el botón está desactivado, pero por si acaso
                            showStatusMessage(`El audio ya está en '${playlist.name}'`, 'error');
                        }
                    }
                };
            }
            
            
            // --- NUEVO: Lógica de Edición y D&D de Playlist ---
            
            // Listener para el botón de edición en la sidebar (añadido en renderPlaylists)
            if (playlistList) {
                playlistList.addEventListener('click', (e) => {
                    const editButton = e.target.closest('.edit-playlist-btn');
                    if (editButton) {
                        const playlistId = parseInt(editButton.dataset.playlistId);
                        openEditPlaylistModal(playlistId);
                    }
                });
            }
            
            /**
             * Abre el modal de edición y carga los datos de la playlist. (Nuevo)
             */
            function openEditPlaylistModal(playlistId) {
                if (!db) return;
                
                const transaction = db.transaction([STORE_PLAYLISTS], 'readonly');
                const store = transaction.objectStore(STORE_PLAYLISTS);
                const request = store.get(playlistId);
                
                request.onsuccess = async (e) => {
                    const playlist = e.target.result;
                    if (!playlist) return;
                    
                    currentPlaylistBeingEdited = playlist;
                    
                    editPlaylistNameTitle.textContent = playlist.name;
                    playlistNameInput.value = playlist.name;
                    playlistDescriptionInput.value = playlist.description || '';
                    
                    // 1. Cargar Cover
                    if (playlist.artworkBlob) {
                        const artUrl = URL.createObjectURL(playlist.artworkBlob);
                        playlistCoverImageContainer.innerHTML = `<img src="${artUrl}" alt="Playlist Cover">`;
                    } else {
                        playlistCoverImageContainer.innerHTML = `<svg class="icon" style="width: 50px; height: 50px; stroke: var(--text-secondary);"><use href="#icon-music"></use></svg>
                        <span style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 5px;">Añadir Cover</span>`;
                    }
                    
                    // 2. Cargar y renderizar Tracks (Incluye D&D setup)
                    await renderPlaylistTracksForEditing(playlist.tracks);
                    
                    showModal('editPlaylistModal');
                };
            }
            
            /**
             * Renderiza los tracks de la playlist para el modal de edición. (Nuevo)
             */
            async function renderPlaylistTracksForEditing(trackIds) {
                playlistEditTrackList.innerHTML = '<li class="empty-list-message">Cargando...</li>';
                
                if (trackIds.length === 0) {
                    playlistEditTrackList.innerHTML = '<li class="empty-list-message">Esta playlist no tiene canciones.</li>';
                    return;
                }
                
                const trackPromises = trackIds.map(id => 
                    new Promise(resolve => getFileFromDB(id, resolve))
                );
                const tracks = await Promise.all(trackPromises);
                
                playlistEditTrackList.innerHTML = '';
                
                tracks.forEach((track) => {
                    if (!track) return;
                    
                    const li = document.createElement('li');
                    li.className = 'edit-track-item';
                    li.setAttribute('draggable', 'true');
                    li.dataset.id = track.id;
                    
                    li.innerHTML = `
                        <span class="drag-handle" aria-label="Arrastrar pista">⋮⋮</span>
                        <div class="track-title-edit">${track.title} (${track.artist || 'Desconocido'})</div>
                        <button class="track-remove-btn" data-id="${track.id}" aria-label="Eliminar de playlist">
                            <svg class="icon"><use href="#icon-x"></use></svg>
                        </button>
                    `;
                    playlistEditTrackList.appendChild(li);
                });
                
                setupDragAndDrop();
            }

            /**
             * Guarda los cambios de nombre, descripción, cover y reordenación. (Nuevo)
             */
            if (savePlaylistEditBtn) {
                savePlaylistEditBtn.addEventListener('click', () => {
                    if (!currentPlaylistBeingEdited) return;

                    const newName = playlistNameInput.value.trim();
                    if (!newName) {
                        showStatusMessage("El nombre de la playlist no puede estar vacío.", "error");
                        return;
                    }
                    
                    // 1. Obtener el nuevo orden de tracks
                    const reorderedTracks = Array.from(playlistEditTrackList.querySelectorAll('.edit-track-item'))
                        .map(item => parseInt(item.dataset.id));
                        
                    // 2. Crear el objeto actualizado
                    const updatedPlaylist = {
                        ...currentPlaylistBeingEdited,
                        name: newName,
                        description: playlistDescriptionInput.value,
                        tracks: reorderedTracks,
                        // artworkBlob se actualiza en el listener de coverFileInput
                    };
                    
                    // 3. Guardar en DB
                    putDataInDB(STORE_PLAYLISTS, updatedPlaylist, () => {
                        showStatusMessage(`Playlist '${newName}' actualizada.`, 'success');
                        hideModal('editPlaylistModal');
                        renderPlaylists(); // Refrescar sidebar
                        currentPlaylistBeingEdited = null;
                    });
                });
            }
            
            /**
             * Maneja la subida de cover de playlist. (Nuevo)
             */
            if (playlistCoverPreview) {
                playlistCoverPreview.addEventListener('click', () => {
                    coverFileInput.click();
                });
            }
            
            if (coverFileInput) {
                coverFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file || !file.type.startsWith('image/')) {
                        showStatusMessage("Por favor, selecciona un archivo de imagen.", "error");
                        return;
                    }
                    
                    // 1. Almacenar el archivo Blob para guardarlo luego
                    currentPlaylistBeingEdited.artworkBlob = file; 
                    
                    // 2. Mostrar preview usando FileReader
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        playlistCoverImageContainer.innerHTML = `<img src="${event.target.result}" alt="Playlist Cover">`;
                        showStatusMessage("Carátula cargada. Pulsa 'Guardar Cambios' para persistir.", "success");
                    };
                    reader.readAsDataURL(file); 
                });
            }
            
            // Listener para remover canción desde la edición de playlist
            if (playlistEditTrackList) {
                playlistEditTrackList.addEventListener('click', (e) => {
                    const removeButton = e.target.closest('.track-remove-btn');
                    if (removeButton && currentPlaylistBeingEdited) {
                        const trackIdToRemove = parseInt(removeButton.dataset.id);
                        
                        // Eliminar de la lista visual y del objeto en edición
                        const trackIndex = currentPlaylistBeingEdited.tracks.indexOf(trackIdToRemove);
                        if (trackIndex > -1) {
                            currentPlaylistBeingEdited.tracks.splice(trackIndex, 1);
                            removeButton.closest('.edit-track-item').remove();
                            showStatusMessage("Pista eliminada. Pulsa 'Guardar Cambios'.", "success");
                        }
                    }
                });
            }
            
            /**
             * Configura los event listeners para Drag and Drop. (Nuevo)
             */
            function setupDragAndDrop() {
                let dragSrcEl = null;

                function handleDragStart(e) {
                    dragSrcEl = this;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.innerHTML);
                    this.classList.add('dragging');
                }

                function handleDragOver(e) {
                    e.preventDefault(); // Necesario para que funcione el drop
                    e.dataTransfer.dropEffect = 'move';
                    return false;
                }

                function handleDragEnter(e) {
                    this.classList.add('drag-over-target');
                }

                function handleDragLeave(e) {
                    this.classList.remove('drag-over-target');
                }

                function handleDrop(e) {
                    e.stopPropagation();
                    
                    const dragEl = dragSrcEl.cloneNode(true);
                    
                    if (dragSrcEl !== this) {
                        const targetList = this.parentNode;
                        targetList.insertBefore(dragEl, this.nextSibling); 
                        dragSrcEl.remove();
                        // Reaplicar D&D a los nuevos nodos (necesario tras manipulación del DOM)
                        setupDragAndDrop(); 
                        showStatusMessage("Pista reordenada. Pulsa 'Guardar Cambios'.", "success");
                    }

                    this.classList.remove('drag-over-target');
                    return false;
                }

                function handleDragEnd(e) {
                    this.classList.remove('dragging');
                    document.querySelectorAll('.edit-track-item').forEach(item => {
                        item.classList.remove('drag-over-target');
                    });
                }

                document.querySelectorAll('.edit-track-item').forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragenter', handleDragEnter);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('dragleave', handleDragLeave);
                    item.addEventListener('drop', handleDrop);
                    item.addEventListener('dragend', handleDragEnd);
                });
            }

            // --- 8. Helpers ---
            
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            
            // --- 9. Lógica del Canvas de Partículas (NUEVO) ---
            
            /**
             * Inicializa el Web Audio API para la visualización
             */
            function setupAudioVisualization() {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    source = audioContext.createMediaElementSource(audio); // 'audio' es el <audio>
                    
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                    
                    // MODIFICADO: Ajustado para 64 barras
                    analyser.fftSize = 128; // Potencia de 2.
                    const bufferLength = analyser.frequencyBinCount; // Ahora será 64
                    dataArray = new Uint8Array(bufferLength);
                    
                    audioSetupDone = true;
                    console.log("Visualizador de audio inicializado.");
                } catch (e) {
                    console.error("Error al inicializar Web Audio API:", e);
                    showStatusMessage("Error al iniciar el visualizador de audio.", "error");
                }
            }

            /**
             * Ajusta el tamaño del canvas al de la ventana
             */
            function resizeCanvas() {
                particleCanvas.width = window.innerWidth;
                particleCanvas.height = window.innerHeight;
                // MODIFICADO: Redimensionar el canvas del header
                resizeHeaderCanvas();
                // Reiniciar partículas al cambiar tamaño para evitar distorsión
                initParticles();
            }

            /**
             * MODIFICADO: Redimensiona el canvas del header
             */
            function resizeHeaderCanvas() {
                if (!headerWaveCanvas) return;
                try {
                    const headerRect = document.querySelector('.app-header').getBoundingClientRect();
                    headerWaveCanvas.width = headerRect.width;
                    headerWaveCanvas.height = headerRect.height;
                } catch (e) {
                    console.error("Error al redimensionar header canvas:", e);
                }
            }


            /**
             * Define una Partícula
             */
            class Particle {
                constructor() {
                    this.reset();
                    this.baseRadius = (Math.random() * 2 + 1);
                    this.radius = this.baseRadius;
                    this.baseVelocity = -(Math.random() * 0.5 + 0.2); // Velocidad base hacia arriba
                }

                reset() {
                    this.x = Math.random() * particleCanvas.width;
                    this.y = particleCanvas.height + Math.random() * 100; // Empezar abajo
                }

                update(bassLevel) {
                    // Mover la partícula
                    // El 'boost' hace que se mueva más rápido con los bajos
                    let boost = (bassLevel / 255) * 4; // Multiplicador de velocidad
                    this.y += this.baseVelocity - boost;
                    
                    // El 'swell' hace que crezca con los bajos
                    let swell = (bassLevel / 255) * 1.5; // Multiplicador de tamaño
                    this.radius = this.baseRadius + swell;

                    // Resetear si se sale por arriba
                    if (this.y < -this.radius) {
                        this.reset();
                    }
                }

                draw() {
                    particleCtx.beginPath();
                    particleCtx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    particleCtx.fillStyle = particleColor; // Usar el color del tema
                    particleCtx.fill();
                    particleCtx.closePath();
                }
            }

            /**
             * Crea el array inicial de partículas
             */
            function initParticles() {
                particles = [];
                let particleCount = 100; // Número de partículas
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle());
                }
            }

            /**
             * El loop principal de animación del canvas
             * MODIFICADO: Renombrado de animateParticles a animateVisuals
             */
            function animateVisuals() {
                requestAnimationFrame(animateVisuals); // Pedir el siguiente frame
                
                if (!particlesEnabled) {
                    // Si está desactivado, no dibujar nada (ya se limpiaron al desactivar)
                    return;
                }

                // Limpiar canvas de partículas
                particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);

                let bassLevel = 0;
                if (analyser && dataArray) {
                    analyser.getByteFrequencyData(dataArray); // Obtener datos de frecuencia
                    
                    // 1. Calcular Bass (para partículas)
                    let bassSum = 0;
                    for(let i = 0; i < 5; i++) {
                        bassSum += dataArray[i];
                    }
                    bassLevel = bassSum / 5; // Promedio de 0-255

                    // 2. MODIFICADO: Dibujar Barras (con todos los datos)
                    drawHeaderVisualizer(); 
                }

                // 3. Actualizar y dibujar partículas
                particles.forEach(p => {
                    p.update(bassLevel);
                    p.draw();
                });
            }

            /**
             * MODIFICADO: Dibuja el visualizador de barras en el canvas del header
             */
            function drawHeaderVisualizer() {
                if (!headerWaveCtx || !dataArray) return;
                
                const canvas = headerWaveCanvas;
                const ctx = headerWaveCtx;
                const bufferLength = analyser.frequencyBinCount; // 64

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = (canvas.width / bufferLength) * 0.9; // 90% ancho
                const barSpacing = (canvas.width / bufferLength) * 0.1; // 10% espacio
                let x = 0;

                // Estilo de neón
                ctx.fillStyle = particleColor;
                ctx.shadowColor = particleColor;
                ctx.shadowBlur = 5;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 255.0; // Valor normalizado (0-1)
                    // Altura máxima de la barra (90% de la altura del header)
                    const barHeight = v * (canvas.height * 0.9); 
                    
                    // Dibujar la barra desde el centro vertical, expandiéndose
                    ctx.fillRect(
                        x, 
                        (canvas.height - barHeight) / 2, // Posición Y (centrada)
                        barWidth, 
                        barHeight
                    );
                    
                    x += barWidth + barSpacing; // Moverse a la siguiente barra
                }

                // Resetear sombra
                ctx.shadowBlur = 0;
            }

            // Sobrescribir `loadAndPlayTrack` para iniciar el audio context
            const originalLoadAndPlayTrack = loadAndPlayTrack;
            loadAndPlayTrack = (src, title, artist = 'Desconocido', artUrl = null) => {
                if (!audioSetupDone) {
                    setupAudioVisualization();
                }
                originalLoadAndPlayTrack(src, title, artist, artUrl);
            }

            
            // --- Carga Inicial ---
            openDb();
            switchView('calendar');
        });
    </script>
</body>
</html>
